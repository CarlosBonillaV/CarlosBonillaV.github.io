/*! Horsefly - Modules - 2022-03-03 4:55:06PM */

var DEBUG=HF.isDev,pathNow="",modalNow="",extNow=[],perspective=["chart","demand"],sessionTimer=null,csvLimit=Number(window.csvLocs),pathAws="",pathApi="http://107.21.39.157:9751/",$app=$("#horsefly-app"),_country=[{code:"ae",currency:"aed"},{code:"ar",currency:"ars"},{code:"au",currency:"aud"},{code:"be",currency:"euro"},{code:"bg",currency:"bgn"},{code:"br",currency:"br"},{code:"ca",currency:"cad"},{code:"ch",currency:"chf"},{code:"cl",currency:"clp"},{code:"cn",currency:"cny"},{code:"cz",currency:"czk"},{code:"de",currency:"euro"},{code:"dk",currency:"euro"},{code:"es",currency:"euro"},{code:"fi",currency:"euro"},{code:"fr",currency:"euro"},{code:"gt",currency:"gtq"},{code:"hu",currency:"huf"},{code:"ie",currency:"euro"},{code:"in",currency:"in"},{code:"it",currency:"euro"},{code:"jp",currency:"jpy"},{code:"hk",currency:"hkd"},{code:"mx",currency:"mxn"},{code:"my",currency:"myr"},{code:"nl",currency:"euro"},{code:"no",currency:"nok"},{code:"nz",currency:"nzd"},{code:"pe",currency:"sol"},{code:"ph",currency:"ph"},{code:"pl",currency:"pln"},{code:"pt",currency:"euro"},{code:"ro",currency:"ron"},{code:"ru",currency:"rub"},{code:"sa",currency:"sar"},{code:"se",currency:"sek"},{code:"sg",currency:"sgd"},{code:"sv",currency:"dollar"},{code:"ua",currency:"uah"},{code:"uk",currency:"pound"},{code:"us",currency:"dollar"},{code:"za",currency:"zar"}],_currency=[{id:"euro",code:"EUR",symbol:"€",name:"Euro"},{id:"pound",code:"GBP",symbol:"£",name:"British pound sterling"},{id:"dollar",code:"USD",symbol:"$",name:"United States dollar"},{id:"aed",code:"AED",symbol:"د.إ",name:"United Arab Emirates dirham"},{id:"ars",code:"ARS",symbol:"$",name:"Argentine peso"},{id:"aud",code:"AUD",symbol:"$",name:"Australian dollar"},{id:"bgn",code:"BGN",symbol:"лв",name:"Bulgarian lev"},{id:"br",code:"BRL",symbol:"R$",name:"Brazilian real"},{id:"cad",code:"CAD",symbol:"$",name:"Canadian dollar"},{id:"chf",code:"CHF",symbol:"SFr.",name:"Swiss franc"},{id:"clp",code:"CLP",symbol:"$",name:"Chilean peso"},{id:"cny",code:"CNY",symbol:"¥",name:"Chinese yuan renminbi"},{id:"czk",code:"CZK",symbol:"Kč",name:"Czech koruna"},{id:"gtq",code:"GTQ",symbol:"Q",name:"Guatemalan quetzal"},{id:"hkd",code:"HKD",symbol:"HK$",name:"Hong Kong dollar"},{id:"huf",code:"HUF",symbol:"Ft",name:"Hungarian forint"},{id:"in",code:"INR",symbol:"₹",name:"Indian rupee"},{id:"jpy",code:"JPY",symbol:"¥",name:"Japanese yen"},{id:"mxn",code:"MXN",symbol:"$",name:"Mexican peso"},{id:"myr",code:"MYR",symbol:"RM",name:"Malaysian ringgit"},{id:"nok",code:"NOK",symbol:"kr",name:"Norwegian krone"},{id:"nzd",code:"NZD",symbol:"$",name:"New Zealand dollar"},{id:"sol",code:"SOL",symbol:"S/",name:"Peruvian Sol"},{id:"ph",code:"PHP",symbol:"₱",name:"Philippine peso"},{id:"pln",code:"PLN",symbol:"zł",name:"Polish zloty"},{id:"ron",code:"RON",symbol:"lei",name:"Romanian leu"},{id:"rub",code:"RUB",symbol:"₽",name:"Russian ruble"},{id:"sar",code:"SAR",symbol:"SR",name:"Saudi riyal"},{id:"sek",code:"SEK",symbol:"kr",name:"Swedish krona"},{id:"sgd",code:"SGD",symbol:"S$",name:"Singapore dollar"},{id:"uah",code:"UAH",symbol:"₴",name:"Ukrainian hryvnia"},{id:"zar",code:"ZAR",symbol:"R",name:"South African rand"}];HF.utils=function(){function capAll(strAll){var srtArr=strAll.split(" ");return(srtArr=srtArr.map(function(str){return capFirst(str)})).join(" ")}function capFirst(str){return str.charAt(0).toUpperCase()+str.slice(1)}return{toPercent:function(value,total,precision,noEntity,zeroToNA){var percent=100*value/total,multiplier=Math.pow(10,precision||0),result=Math.round(percent*multiplier)/multiplier;return!zeroToNA||100!==result&&0!==result?noEntity?result:result+"%":"n/a"},addCommas:function(number,currency){var symbol;if(currency){var currencies=_currency.filter(function(cur){return cur.id===currency});currencies.length&&(symbol=currencies[0].symbol)}else symbol="";number+="",x=number.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var regx=/(\d+)(\d{3})/;regx.test(x1);)x1=x1.replace(regx,"$1,$2");return symbol+x1+x2},getCurrencyCode:function(currency){var code,currencies=_currency.filter(function(cur){return cur.id===currency});return currencies.length&&(code=currencies[0].code),code},isEmptyObj:function(el){if(el.constructor===Object){for(var key in el)return!1;return!0}},codeToName:function(key){return _country.filter(function(cc){return cc.code===key}).map(function(cn){return cn.name})[0]},getContinent:function(key){return _country.filter(function(cc){return cc.code===key}).map(function(cn){return cn.continent})[0]},locationFormat:function(array){return(array=array.map(function(str){return capAll(str)})).join(", ")},capAll:capAll,capFirst:capFirst}}(),Handlebars.registerHelper("debug",function(optionalValue){}),Handlebars.registerHelper("imageHelper",function(imgUrl,imgAlt){return new Handlebars.SafeString('<img src="'+pathAws+"img/"+imgUrl+'.png" alt="'+imgAlt+'">')}),Handlebars.registerHelper("userNameFirst",function(){return new Handlebars.SafeString(userData.firstname)}),Handlebars.registerHelper("userName",function(){return new Handlebars.SafeString(userData.firstname+" "+userData.lastname)}),Handlebars.registerHelper("is_admin",function(options){return"2"===userData.type?options.fn(this):options.inverse(this)}),Handlebars.registerHelper("if_multi",function(options){return multiCountry?options.fn(this):options.inverse(this)}),Handlebars.registerHelper("has_rate",function(options){return rateEnabled?options.fn(this):options.inverse(this)}),Handlebars.registerHelper("ifMatches",function(conditional,options){return options.hash.toMatch===conditional?options.fn(this):options.inverse(this)}),Handlebars.registerHelper("ifIsTotal",function(conditional,options){return options.hash.total===conditional||0===options.hash.total?options.fn(this):options.inverse(this)}),Handlebars.registerHelper("numFormat",function(value,options){var symbol;if(options.hash.entity){var currencies=_currency.filter(function(cur){return cur.id===options.hash.entity});currencies.length&&(symbol=currencies[0].symbol)}else symbol="";value+="",x=value.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var regx=/(\d+)(\d{3})/;regx.test(x1);)x1=x1.replace(regx,"$1,$2");return new Handlebars.SafeString(symbol+x1+x2)}),Handlebars.registerHelper("numFormatK",function(value,options){var symbol,amount,divider,suffix;if(value>999999?(divider=1e4,suffix="M"):value>999?(divider=1e3,suffix="K"):(divider=1,suffix=""),options.hash.entity){var currencies=_currency.filter(function(cur){return cur.id===options.hash.entity});currencies.length&&(symbol=currencies[0].symbol)}else symbol="";return amount=options.hash.round?"floor"===options.hash.round?Math.floor(value/divider):Math.ceil(value/divider):Math.round(value/divider),"M"===suffix&&(amount=(amount/100).toFixed(2)),new Handlebars.SafeString(symbol+amount+suffix)}),Handlebars.registerHelper("meterMin",function(value,options){return 100*value/options.hash.total}),Handlebars.registerHelper("meterMax",function(value,options){return 100-100*value/options.hash.total}),Handlebars.registerHelper("pctRound",function(value,options){var percent=100*value/options.hash.total,multiplier=Math.pow(10,0);return Math.round(percent*multiplier)/multiplier}),Handlebars.registerHelper("pctRoundFill",function(value,options){var percent=100*value/options.hash.total,multiplier=Math.pow(10,0);return 100-Math.round(percent*multiplier)/multiplier});var events={events:{},on:function(eventName,fn){this.events[eventName]=this.events[eventName]||[],this.events[eventName].push(fn)},off:function(eventName,fn){if(this.events[eventName])for(var i=0;i<this.events[eventName].length;i++)if(this.events[eventName][i]===fn){this.events[eventName].splice(i,1);break}},emit:function(eventName,data){this.events[eventName]&&this.events[eventName].forEach(function(fn){fn(data)})}};HF.views=function(){function checkSession(){$.ajax({type:"GET",url:pathApi+"horsefly/sessions/check?uuid="+window.uuid,crossDomain:!0,success:function(data){data.active>0&&(clearInterval(sessionTimer),sessionTimer=null),1===data.active?modal({modalurl:"doLogout",bgclose:!1}):2===data.active&&modal({modalurl:"loggedOut",bgclose:!1})}})}function set(baseName,viewName,wrapID){var el,eq;if(!baseName||!viewName){return!1}if("same"===(eq=_viewPathEq(baseName+"-"+viewName)))return!1;"none"===eq&&(el=wrapID||"key",pathNow?_unbindPrevious("base",baseName,viewName,el):_setBase(baseName,viewName,el)),"base"===eq&&_unbindPrevious("content",baseName,viewName,el=wrapID||"base-contents")}function modal(options){if(modalNow&&options.modalurl===modalNow)return!1;var bgClose=void 0===options.bgclose||options.bgclose,isInfo=void 0!==options.isinfo&&options.isinfo;$modalWrap.hasClass("show")?_modalHide(options.modalurl,bgClose,isInfo):($backdrop.fadeIn(300),_modalShow(options.modalurl,bgClose,isInfo))}function _unbindPrevious(type,baseName,viewName,el){$("#"+el).addClass("loading");var pathArgs=pathNow.split("-"),prevBase=pathArgs[0],tempView=pathArgs[1],prevView="results"===prevBase&&0===tempView.indexOf("level")?"list":tempView,whenView="base"===type?HF[prevBase].unload(tempView):HF[baseName][prevView].unload(tempView);$.when(whenView).then(function(unloaded){unloaded&&("base"===type?_setBase(baseName,viewName,el):_setView(baseName,viewName,el))})}function _setBase(baseName,viewName,el){$el=$("#"+el),$el.addClass("loading").empty();var elWrapper,elTemplate,elContext;$.when(HF.views.base.get(baseName)).then(function(baseData){return baseData?(elWrapper=baseData[1],elTemplate=baseData[0],elContext=baseData[2],_renderPartial($el,elTemplate,elContext)):"404"}).then(function(rendered){rendered?"404"===rendered?_404($el):(HF[baseName].init(viewName),_setView(baseName,viewName,elWrapper)):_error($el,"view")})}function _setView(baseName,viewName,el){$el=$("#"+el),$el.addClass("loading").empty();var isLevel="results"===baseName&&0===viewName.indexOf("level"),partial=isLevel?"view_"+baseName+"_list":"view_"+baseName+"_"+viewName;$.when(HF[baseName][isLevel?"list":viewName].getData()).then(function(context){return _renderPartial($el,partial,context)}).done(function(rendered){rendered?(pathNow=baseName+"-"+viewName,HF[baseName][isLevel?"list":viewName].init(el)):_404($el)})}function _showDetails(viewName,geoPoint,geoName,trigger,el){$el=el?$("#"+el):$("#ext"),$el.attr("class","loading").empty();var partial="extra_"+viewName;$.when(HF[viewName].getData(geoPoint,geoName,trigger)).then(function(context){return _renderPartial($el,partial,context)}).done(function(rendered){rendered?(extNow=[viewName,geoPoint],HF[viewName].init(el)):_404($el)})}function _modalShow(modalName,closeWithBg,isInfo){$modalWrap.html('<div class="m-x"><div class="m-y"><div class="m-z"></div></div></div>');var $modal=$modalWrap.find(".m-z"),partial="modal_"+modalName;$.when(_renderPartial($modal,partial,null)).then(function(rendered){return!!rendered&&(!!isInfo||HF.modal[modalName].load($modal))}).done(function(loaded){loaded?($modalWrap.attr("aria-hidden","false").addClass("show").animate({opacity:1},300,function(){modalNow=modalName}),closeWithBg?$modalWrap.on("click",".m-x, .m-close",function(e){e.preventDefault(),_modalHide(0,0,isInfo)}):$modalWrap.on("click",".m-close",function(e){e.preventDefault(),_modalHide(0,0,isInfo)}),$modalWrap.on("click",".m-z > div",function(e){e.stopPropagation()})):_modalHide(0,0,!0)})}function _modalHide(urlModal,closeWithBg,isInfo){var shouldUnload=!!isInfo||HF.modal[modalNow].unload();$.when(shouldUnload).then(function(unloaded){unloaded&&(isInfo&&(modalNow=""),$modalWrap.animate({opacity:0},300,function(){$(this).off().attr("aria-hidden","true").removeClass("show").empty(),urlModal?_modalShow(urlModal,closeWithBg):$backdrop.fadeOut(300)}))})}function _renderPartial($el,partial,context,append){var isReady=$.Deferred(),exists=_partialExists(partial);return exists&&(append?$el.append(context?templates[partial](context):templates[partial]()):$el.html(context?templates[partial](context):templates[partial]())),isReady.resolve(exists),isReady.promise()}function _error($el,elType,customMsg){var errorMsg;"view"===elType&&(pathNow="error"),errorMsg=customMsg||(elType?"There was an error loading this "+elType:"Something went wrong!"),$el.html('<div class="module-error-msg">'+errorMsg+"</div>").removeClass("loading")}function _404($el){$.when(_renderPartial($el,"view_not_found")).done(function(rendered){rendered?(pathNow="not-found",$el.removeClass("loading")):_error($el,"view")})}function _partialExists(partial){return templates.hasOwnProperty(partial)}function _viewPathEq(pathView){var eq="none";if(pathNow)if(pathNow===pathView)eq="same";else{var pathCur=pathNow.split("-"),pathNxt=pathView.split("-");pathCur[0]===pathNxt[0]&&(eq="base")}return eq}function _initialContents(){set("search","build","key"),HF.map.init("alt"),$toggleChat=$("#toggleChat"),$("#toggleChat").length&&$toggleChat.on("click",function(e){e.preventDefault(),$("#hubspot-messages-iframe-container").toggleClass("hidden")}),window.notAlone?modal(1===window.notAlone?{modalurl:"doLogout",bgclose:!1}:{modalurl:"loggedOut",bgclose:!1}):sessionTimer=setInterval(checkSession,15e3)}function _renderLayout(){$app.append(templates.layoutBody()),viewsReady=!0,_initialContents()}function _compileTemplates($temp){$temp.find("script").each(function(){var name=$(this).attr("name"),src=$(this).html(),partial=$(this).attr("partial-name");partial&&Handlebars.registerPartial(partial,src),templates[name]=Handlebars.compile(src)}),$temp.remove(),_renderLayout()}var templates={},viewsReady=!1,$modalWrap=$("#modal"),$backdrop=$(".backdrop"),$toggleChat=null;return events.on("doneLoading",function(el){$("#"+el).removeClass("loading")}),viewsReady||(HF.modal={},function(){var pathTmpl=HF.isDev?"dev":"prod";$.ajax({type:"GET",url:pathAws+"tmpl/"+pathTmpl+".html?v="+version,crossDomain:!0,cache:!0,success:function(data){var $temp=$("<div />",{id:"temp"});$temp.html(data).appendTo("body"),_compileTemplates($temp)}})}()),{set:set,addModule:function($el,modName,context){var isReady=$.Deferred(),partial="mod_"+modName;return $.when(_renderPartial($el,partial,context,!0)).then(function(complete){complete||_error($el,"module"),isReady.resolve(complete)}),isReady.promise()},setDetails:function(viewName,geoPoint,geoName,trigger,el){if(extNow.length>0){if(extNow[0]===viewName&&extNow[1]===geoPoint)return!1;var prevView=extNow[0];$.when(HF[prevView].unload()).then(function(unloaded){unloaded&&_showDetails(viewName,geoPoint,geoName,trigger,el)})}else _showDetails(viewName,geoPoint,geoName,trigger,el)},modal:modal,checkSession:checkSession}}(),HF.views.base=function(){var baseConf={search:{baseTmpl:"base_tabs",wrapper:"base-contents",context:{tabItems:[{viewName:"build",tabTitle:"search builder"},{viewName:"saved",tabTitle:"saved searches"},{viewName:"upload",tabTitle:"upload cvs"}]}},results:{baseTmpl:"base_simple",wrapper:"base-contents"}};return{get:function(base){return!!baseConf[base]&&[baseConf[base].baseTmpl,baseConf[base].wrapper,baseConf[base].context]}}}(),HF.search=function(){function _eventsBind(subview){$elControl=$("#base-controls"),$elContent=$("#base-contents"),$elTabList=$elControl.children(".tabs"),elMainWrap=$elControl.closest("section").attr("id"),$elTabList.find('a[data-tab="'+subview+'"]').parent("li").addClass("active"),$elTabList.on("click","a",function(e){if(e.preventDefault(),e.stopPropagation(),$(this).parent().hasClass("active"))return!1;_toggleView($(this).data("tab"))})}function _eventsUnbind(){$elTabList.off("click","a"),$elControl=null,$elContent=null,$elTabList=null,elMainWrap=null}function _toggleView(viewName){$elTabList.children("li.active").removeClass("active"),$elTabList.find('a[data-tab="'+viewName+'"]').parent("li").addClass("active"),HF.views.set(baseID,viewName)}var $elControl,$elContent,$elTabList,elMainWrap,baseID="search";return{init:function(subView){_eventsBind(subView),events.emit("doneLoading",elMainWrap)},getData:function(type){return!1},unload:function(subview){var baseUnload=$.Deferred();return $.when(HF[baseID][subview].unload()).then(function(viewUnload){viewUnload&&(_eventsUnbind(),baseUnload.resolve(viewUnload))}),baseUnload.promise()}}}(),HF.search.build=function(){function _eventsBind(){$createGroupBtn=$("#create-tag-group"),$createLocGroupBtn=$("#create-loc-group"),$searchActions=$("#search-actions"),$searchButtons=$searchActions.find("a.btn"),$createGroupBtn.on("click",function(e){if(e.preventDefault(),e.stopPropagation(),$(this).hasClass("disabled"))return!1;_addTagGroup()}),$createLocGroupBtn.on("click",function(e){if(e.preventDefault(),e.stopPropagation(),$(this).hasClass("disabled"))return!1;_addLocGroup()}),$filters.on("click","a",function(e){e.preventDefault(),e.stopPropagation();var parent=$(this).parent();parent.hasClass("show")?(parent.removeClass("show"),$(document).off("click",_closeFilters)):(parent.addClass("show"),$(document).on("click",_closeFilters))}),$filters.on("change","input[type=checkbox]",function(e){var len=$(this).closest(".filter-block").find("input[type=checkbox]:checked").length;this.checked||len?_config.filterData[this.value]=this.checked?1:0:$(this).prop("checked",!0)})}function _eventsUnbind(){tagGroupLen=0,locGroupLen=0,$createGroupBtn.off("click"),$createLocGroupBtn.off("click"),$searchButtons.off("click"),$filters.off("click"),$filters.off("change"),$createGroupBtn=null,$createLocGroupBtn=null,$filters=null,$searchActions=null,$searchButtons=null}function _getSavedData(sid){var payload={searchId:parseInt(sid)};return $.ajax({type:"POST",url:pathApi+"horsefly/search",data:payload,dataType:"json",crossDomain:!0})}function _loadSavedData(data){_config.cachedTags.length=0,_config.cachedLocs.length=0,_config.searchData.geo=0;var geoArray=data.geoPath.split("/");return geoArray.shift(),geoArray=geoArray.map(function(item){return"0"===item?0:item}),_config.searchData.rad="0"===data.distance?"":Number(data.distance),_config.searchData.cur=data.currency?data.currency:"pound",_config.searchData.geo=geoArray,_config.cachedTags=data.tags.or,_config.cachedLocs=JSON.parse(data.geoPath),!0}function _addTagGroup(){var isReady=$.Deferred();return $.when(HF.tags.addGroup("tag-groups",tagGroupLen)).then(function(complete){complete&&($("#tag-group-"+tagGroupLen).removeClass("loading"),$("#create-tag-group").addClass("disabled"),tagGroupLen++,isReady.resolve(complete))}),isReady.promise()}function _allTagGroups(len){var isReady=$.Deferred();return $.when(HF.tags.setGroups("tag-groups",_config.cachedTags)).then(function(complete){complete&&(tagGroupLen=len,isReady.resolve(complete))}),isReady.promise()}function _addLocGroup(){var isReady=$.Deferred();return $.when(HF.locs.addGroup("loc-groups",locGroupLen)).then(function(complete){complete&&($("#loc-group-"+locGroupLen).removeClass("loading"),locGroupLen&&$("#create-loc-group").addClass("disabled"),locGroupLen++,isReady.resolve(complete))}),isReady.promise()}function _allLocGroups(len){var isReady=$.Deferred();return $.when(HF.locs.setGroups("loc-groups",_config.cachedLocs)).then(function(complete){complete&&(locGroupLen=len,isReady.resolve(complete))}),isReady.promise()}function _exploreResults(){$.when(HF.locs.getGroups(),HF.tags.getBool()).then(function(locGroupArray,tagGroupArray){_config.cachedLocs=locGroupArray;var data=$.extend(!0,{},_config.searchData),filters=$.extend(!0,{},_config.filterData),payload={tags:JSON.stringify({or:tagGroupArray}),locations:JSON.stringify(locGroupArray),currency:data.cur,filters:JSON.stringify(filters),token:"xtempx"};data.payload=payload,events.emit("searchSetup",data)})}function _deepReset(){_config.cachedTags.length=0,_config.cachedLocs.length=0,_config.searchData.cur="pound",_config.searchData.rad="",_config.searchData.geo[0]="northern europe",_config.searchData.geo[1]="uk",_config.searchData.geo[2]=0,_config.searchData.geo[3]=0,_resetFilters(!1),HF.views.set("search","build")}function _resetSearch(){var $wrap=$("#tag-groups");$wrap.addClass("loading"),tagGroupLen=0,locGroupLen=0,$.when(HF.selects.clean(),HF.locs.resetAll(),HF.tags.resetAll("tag-groups",tagGroupLen)).then(function(resetLocs,resetTags){resetLocs&&resetTags&&(_resetFilters(!0),$("#tag-group-"+tagGroupLen).removeClass("loading"),tagGroupLen++,locGroupLen++,$wrap.removeClass("loading"))})}function _setFilters(){$filters=$("#filters");for(var key in _config.filterData)_config.filterData.hasOwnProperty(key)&&$filters.find("#"+key).prop("checked",!!_config.filterData[key])}function _resetFilters(resetDOM){resetDOM&&$filters.find("input[type=checkbox]").prop("checked",!0);for(var key in _config.filterData)_config.filterData.hasOwnProperty(key)&&(_config.filterData[key]=1)}function _closeFilters(e){$(e.target).closest("#filters").length||($filters.removeClass("show"),$(document).off("click",_closeFilters))}var elViewWrap,$createGroupBtn,$createLocGroupBtn,$filters,$searchActions,$searchButtons,tagGroupLen=0,locGroupLen=0,_config={cachedTags:[],cachedLocs:[],searchData:{geo:["northern europe","uk",0,0],cur:"pound",rad:""},filterData:{male:1,female:1,yoe0:1,yoe1:1,yoe2:1}};return events.on("groupStatus",function(status){"noSearch"===status&&($createGroupBtn.addClass("disabled"),$searchActions.hasClass("ready")&&($searchActions.removeClass("ready"),$searchButtons.off("click"))),"isEmpty"===status&&$createGroupBtn.addClass("disabled"),"canAdd"===status&&$createGroupBtn.removeClass("disabled"),"noSearch"!==status&&($searchActions.hasClass("ready")||($searchActions.addClass("ready"),$searchButtons.on("click",function(e){e.preventDefault(),e.stopPropagation(),"explore"===$(this).data("action")?_exploreResults():_resetSearch()})))}),{init:function(el){var cachedTagsLen=_config.cachedTags.length,cachedLocsLen=_config.cachedLocs.length;elViewWrap=el,$.when(HF.selects.init()).then(function(done){if(done)return cachedLocsLen?_allLocGroups(cachedLocsLen):_addLocGroup()}).then(function(added){if(added)return cachedTagsLen?_allTagGroups(cachedTagsLen):_addTagGroup()}).then(function(created){created&&(_setFilters(),_eventsBind(),cachedTagsLen&&events.emit("groupStatus","canAdd"),events.emit("doneLoading",elViewWrap))})},getData:function(type,subtype){return!!type&&(subtype?_config[type][subtype]:_config[type])},setData:function(name,data,pos){var dataObj=_config.searchData;if("search-new"===name)_deepReset();else{if(!dataObj.hasOwnProperty(name))return!1;pos?dataObj[name][pos-1]=data:dataObj[name]=data}},setSaved:function(sid){$.Deferred();$.when(_getSavedData(sid)).then(function(data){data&&_loadSavedData(data)}).then(function(ready){$("#base-controls").find("ul.tabs > li").removeClass("active"),$("#base-controls").find("ul.tabs > li").first().addClass("active"),HF.views.set("search","build")})},unload:function(type){var isUnload=$.Deferred();return $.when(HF.selects.destroyAll(),HF.tags.getBool()).then(function(selDestroy,tagGroups){if(selDestroy&&tagGroups)return _config.cachedTags=tagGroups,_eventsUnbind(),HF.tags.resetAll()}).then(function(tagDestroy){tagDestroy&&isUnload.resolve(tagDestroy)}),isUnload.promise()}}}(),HF.search.saved=function(){function _eventsBind(){var $el=$("#"+elViewWrap);$elFavGroup=$el.find("ul.item-list"),$elBtnDel=$el.find("#delete-selected"),$elCheckAll=$el.find("#checkAll"),$elFilter=$el.find("#filter-input"),$elSortName=$el.find("#sort-name"),_updateBtnDel(_config.checkedFavs.length),$elFavGroup.on("change","input[type=checkbox]",function(e){this.checked?($(this).closest("li").addClass("selected"),_config.checkedFavs.push(this.value)):($(this).closest("li").removeClass("selected"),_config.checkedFavs.splice(_config.checkedFavs.indexOf(this.value,0),1)),_updateBtnDel(_config.checkedFavs.length)}),$elFavGroup.on("click",".actions a",function(e){e.preventDefault(),e.stopPropagation();var sid=$(this).closest("li").data("sid");$(this).hasClass("load")?HF.search.build.setSaved(sid):(_config.toDelete=[sid.toString()],HF.views.modal({modalurl:"deleteSearch",bgclose:!1}))}),$elBtnDel.on("click",function(e){e.preventDefault(),e.stopPropagation(),_config.toDelete=_config.checkedFavs.slice(0),HF.views.modal({modalurl:"deleteSearch",bgclose:!1})}),$elCheckAll.on("change",function(e){var $elFavItem=$elFavGroup.children("li"),len=$elFavItem.length;$elFavItem.toggleClass("selected",this.checked),_config.checkedFavs.length=0,_updateBtnDel(this.checked?len:0),_toggleAllChecks(this.checked,len)}),$elFilter.on("keyup",function(e){var query=e.target.value;$elFavGroup.find("li").filter(function(){var regex=new RegExp(query,"ig"),data=$(this).find("span").text();$(this)[0].style.display=regex.test(data)?"block":"none"})}),$elSortName.on("click",function(e){e.preventDefault();var $elFavItem=$elFavGroup.children("li");$elFavItem.sort(function(a,b){return $(a).find("span").text().toUpperCase()<$(b).find("span").text().toUpperCase()?-1:1}),$.each($elFavItem,function(i,elItem){$elFavGroup.append(elItem)})})}function _eventsUnbind(){$elFavGroup.off("change"),$elFavGroup.off("click"),$elBtnDel.off("click"),$elCheckAll.off("change"),$elFilter.off("keyup"),$elSortName.off("click"),_config.checkedFavs.length=0,_config.toDelete.length=0,$elFavGroup=null,$elBtnDel=null,$elCheckAll=null,$elFilter=null,$elSortName=null}function _getContext(){var ctxReady=$.Deferred();return _config.cachedFavs.length?ctxReady.resolve({favorites:_config.cachedFavs}):$.when(_fetchFavData()).then(function(data){ctxReady.resolve({favorites:data})}),ctxReady.promise()}function _fetchFavData(){return $.ajax({type:"POST",url:apiFavSearch,dataType:"json",crossDomain:!0,dataFilter:function(data){var parsed=JSON.parse(data);return $.isEmptyObject(parsed)||(parsed=parsed.map(function(item){return{searchId:item.id,searchName:item.searchName.toLowerCase()}})),JSON.stringify(parsed)},success:function(favorites){return _config.cachedFavs=favorites,favorites}})}function _updateBtnDel(len){$elBtnDel[0].style.display=len<=0?"none":"block",$elBtnDel.find("span").text(len)}function _toggleAllChecks(isChecked,len){for(var $elFavItems=$elFavGroup.find("input[type=checkbox]"),i=0;i<len;)$elFavItems[i].checked=isChecked,isChecked&&_config.checkedFavs.push($elFavItems[i].value),i++}var elViewWrap,$elFavGroup,$elBtnDel,$elCheckAll,$elFilter,apiFavSearch=pathApi+"horsefly/favoritesearches",_config={cachedFavs:[],checkedFavs:[],toDelete:[]};return{init:function(el){elViewWrap=el,_eventsBind(),events.emit("doneLoading",elViewWrap)},getData:function(type){return type?_config[type]:_getContext()},resetCached:function(){_config.cachedFavs.length=0},updateData:function(isCancel){if(!isCancel){var updated=$.Deferred(),isMulti=_config.toDelete.length>1;return _config.cachedFavs=_config.cachedFavs.filter(function(fav){return _config.toDelete.indexOf(fav.searchId)<0}),isMulti?(_config.checkedFavs.length=0,$elFavGroup.find("li.selected").remove()):(_config.checkedFavs.length&&_config.checkedFavs.splice(_config.checkedFavs.indexOf(_config.toDelete[0],0),1),$elFavGroup.find('li[data-sid="'+_config.toDelete[0]+'"]').remove()),_config.toDelete.length=0,_updateBtnDel(_config.checkedFavs.length),updated.resolve(!0),updated.promise()}_config.toDelete.length=0},unload:function(type){return _eventsUnbind(),!0}}}(),HF.jobposts=function(){function _eventsBind(){return elWrapMain.on("click","a.backbtn",function(e){e.preventDefault(),e.stopPropagation(),_eventsUnbind();var $el=$("#"+elViewWrap);$el.removeClass("jobposts"),setTimeout(function(){$el.addClass("on-back").empty(),elViewWrap=null,extNow.length=0},500)}),elPostItem.on("click","a",function(e){e.preventDefault(),e.stopPropagation(),$("#"+elViewWrap).addClass("loading"),_showJobpost($(this).data("jobpost"))}),!0}function _eventsUnbind(){return elWrapMain.off("click"),elPostItem.off("click"),elWrapMain=null,elWrapDets=null,elPostList=null,elPostItem=null,!0}function _getContext(geoPoint,geoName,trigger){var ctxReady=$.Deferred(),tmpGeoArray=geoPoint.split("/"),tmpGeoLen=tmpGeoArray.filter(function(val){return 0!==val&&"0"!==val&&"all"!==val}).length,tmpChildLen=tmpGeoLen>3?tmpGeoLen-1:tmpGeoLen,tmpGeoName=2===tmpGeoLen?HF.utils.codeToName(tmpGeoArray[tmpChildLen-1]):tmpGeoArray[tmpChildLen];if(!tmpGeoLen){var tmpData=HF.results.list.getData("searchData"),tmpLocs=JSON.parse(tmpData.payload.locations),tmpArr=tmpLocs.length>1?[0,0,0,0]:[tmpLocs[0].subContinent,tmpLocs[0].country,tmpLocs[0].region,tmpLocs[0].city],tmpLen=tmpArr.filter(function(val){return 0!==val&&"0"!==val&&"all"!==val}).length;tmpGeoName=tmpLen?2===tmpLen?HF.utils.codeToName(tmpArr[tmpLen-1]):tmpArr[tmpLen]:"Multiple Locations"}var tmpDisplayName=geoName&&"parent"!==trigger?geoName:tmpGeoName;return $.when(_fetchJobposts(geoPoint,trigger)).then(function(data){ctxReady.resolve({location:tmpGeoName,locName:tmpDisplayName,jobposts:data})}),ctxReady.promise()}function _fetchJobposts(geoPoint,trigger){var searchData=$.extend(!0,{},HF.results.list.getData("searchData")),payload={searchId:HF.results.list.getData("searchId"),trigger:trigger,currency:searchData.cur,filters:searchData.payload.filters};return $.ajax({type:"POST",url:pathApi+"horsefly/list/search/"+geoPoint+"/adverts",data:payload,dataType:"json",crossDomain:!0,dataFilter:function(data){var parsed=JSON.parse(data);return $.isEmptyObject(parsed)||(parsed=parsed.adverts.map(function(item){return{id:item.advertId,title:item.positionName,company:item.companyName,salary:item.salary,currency:searchData.cur,content:item.content}})),JSON.stringify(parsed)},success:function(jobposts){return jobposts}})}function _fetchById(id){var payload={advertId:id},currency=HF.results.list.getData("searchData","cur");return $.ajax({type:"POST",url:pathApi+"horsefly/advert",data:payload,dataType:"json",crossDomain:!0,dataFilter:function(data){var jobpost,parsed=JSON.parse(data);return $.isEmptyObject(parsed)||(jobpost={title:parsed.positionName,company:parsed.companyName,salary:parsed.salary,currency:currency,content:parsed.content}),JSON.stringify(jobpost)},success:function(jobpost){return jobpost}})}function _showJobpost(id){$.when(_fetchById(id)).then(function(jobpost){if(jobpost)return HF.views.addModule(elWrapDets,"jobpost_details",jobpost)}).then(function(done){if(done){var $el=$("#"+elViewWrap);$el.addClass("details"),_eventsDetailBind(),setTimeout(function(){$el.removeClass("loading")},300)}})}function _eventsDetailBind(){elWrapDets.one("click","a.closepane",function(e){e.preventDefault(),e.stopPropagation(),$("#"+elViewWrap).removeClass("details"),setTimeout(function(){elWrapDets.empty()},500)})}var elViewWrap,elWrapMain,elWrapDets,elPostList,elPostItem;return{init:function(el){elViewWrap=el,elWrapMain=$("#ext-wrap"),elWrapDets=$("#ext-details"),elPostList=$("#jobposts-list"),elPostItem=elPostList.children(".jobpost-item"),$.when(_eventsBind()).then(function(binded){binded&&($("#"+elViewWrap).addClass("jobposts"),setTimeout(function(){$("#"+elViewWrap).removeClass("loading")},300))})},getData:function(geoPoint,geoName,trigger){return _getContext(geoPoint,geoName,trigger)},unload:function(){var isUnload=$.Deferred(),$el=$("#"+elViewWrap);return $el.removeClass("jobposts"),$.when(_eventsUnbind()).then(function(unbinded){unbinded&&($el.addClass("on-back").empty(),elViewWrap=null,extNow.length=0,isUnload.resolve(unbinded))}),isUnload.promise()}}}(),HF.candidates=function(){function _eventsBind(){return $elTabList.find('a[data-tab="'+perspective[1]+'"]').parent("li").addClass("active"),$elTabList.on("click","a",function(e){if(e.preventDefault(),e.stopPropagation(),$(this).parent().hasClass("active"))return!1;_toggleView($(this).data("tab"),!0)}),$elWrapMain.on("click","a.backbtn",function(e){e.preventDefault(),e.stopPropagation(),_eventsUnbind();var $el=$("#"+elViewWrap);$el.removeClass("candidates"),setTimeout(function(){$el.addClass("on-back").empty(),elViewWrap=null,extNow.length=0},500)}),$elWrapMain.on("click","a.switch-view",function(e){e.preventDefault(),e.stopPropagation();var viewName=$(this).hasClass("list")?"list":"chart";$(this).toggleClass("list"),_toggleView(viewName,!1)}),$("#"+elChartWrap).on("click","a.projections",function(e){e.preventDefault(),e.stopPropagation(),$("#"+elViewWrap).addClass("loading"),_showProjection($(this).data("type"),$(this).data("value"),"future")}),!0}function _eventsUnbind(){return $elWrapMain.off("click"),$elTabList.off("click"),_geoPoint=null,_trigger=null,_gender=null,_exp=null,_ethnic=null,elChartWrap=null,elEthnicWrap=null,$elWrapMain=null,$elWrapDets=null,$elBreakdown=null,$elChartSwitch=null,$elTabList=null,elTree=null,!0}function _toggleView(viewName,isType){"chart"===perspective[0]&&(elChart&&elChart.destroy(),window.hasEthnicity&&elEthnic&&(elEthnic.destroy(),elEthnic=null)),isType?($elTabList.children("li.active").removeClass("active"),$elTabList.find('a[data-tab="'+viewName+'"]').parent("li").addClass("active"),perspective[1]=viewName,"demand"!==viewName&&"schools"!==viewName||(perspective[2]="candidates")):perspective[0]=viewName,$("#"+elChartWrap).addClass("loading").empty(),window.hasEthnicity&&$("#"+elEthnicWrap).empty(),$elBreakdown.empty(),window.hasAdvertsView&&_initSwitch(),$.when(_getChartData()).then(function(charted){charted&&setTimeout(function(){$("#"+elChartWrap).removeClass("loading")},300)})}function _initSwitch(type){var $opts=$elChartSwitch.find("span");$opts.removeClass("active"),$opts.off("click"),"demand"!==perspective[1]&&"schools"!==perspective[1]?($elChartSwitch.find('span[data-type="'+perspective[2]+'"]').addClass("active"),$elChartSwitch.css("display","inline-block"),$opts.on("click",function(e){if($(this).hasClass("active"))return!1;var value=$(this).data("type");$opts.removeClass("active"),$(this).addClass("active"),_toggleSwitch(value)})):$elChartSwitch.css("display","none")}function _toggleSwitch(type){"chart"===perspective[0]&&(elChart&&elChart.destroy(),window.hasEthnicity&&elEthnic&&(elEthnic.destroy(),elEthnic=null)),$("#"+elChartWrap).addClass("loading").empty(),window.hasEthnicity&&$("#"+elEthnicWrap).empty(),$elBreakdown.empty(),perspective[2]=type,$.when(_getChartData()).then(function(charted){charted&&setTimeout(function(){$("#"+elChartWrap).removeClass("loading")},300)})}function _getBaseData(geoPoint,geoName,trigger){var ctxReady=$.Deferred();_trigger=trigger;var tmpGeoArray=(_geoPoint=geoPoint).split("/"),tmpGeoLen=tmpGeoArray.filter(function(val){return 0!==val&&"0"!==val}).length,tmpChildLen=tmpGeoLen-1,tmpGeoName=2===tmpGeoLen?HF.utils.codeToName(tmpGeoArray[tmpChildLen]):tmpGeoArray[tmpChildLen];if(!tmpGeoLen){var tmpData=HF.results.list.getData("searchData"),tmpArr=JSON.parse(tmpData.payload.locations).length>1?[0,0,0,0]:tmpData.geo,tmpLen=tmpArr.filter(function(val){return 0!==val&&"0"!==val}).length;tmpGeoName=tmpLen?2===tmpLen?HF.utils.codeToName(tmpArr[tmpLen-1]):tmpArr[tmpLen-1]:"Multiple Locations"}var tmpDisplayName=geoName&&"parent"!==trigger?geoName:tmpGeoName;return setTimeout(function(){ctxReady.resolve({location:tmpGeoName,locName:tmpDisplayName,tabItems:_configBase})},300),ctxReady.promise()}function _getChartData(){var chartComplete=$.Deferred();return $.when(_fetchPerspective()).then(function(data){return data&&data.showCharts?"chart"===perspective[0]?"demand"===perspective[1]?(window.hasEthnicity&&_ethnic&&($("#"+elEthnicWrap).css("display","block"),_ethnicityChart(_ethnic)),_combinedChart(data)):(window.hasAdvertsView&&_initSwitch(),_simpleChart(data)):"demand"===perspective[1]?_demandList(data):(window.hasAdvertsView&&_initSwitch(),_simpleList(data)):_errorMsg()}).then(function(chartReady){chartComplete.resolve(chartReady)}),chartComplete.promise()}function _fetchPerspective(){var searchData=$.extend(!0,{},HF.results.list.getData("searchData")),payload={searchId:HF.results.list.getData("searchId"),trigger:_trigger,type:perspective[2],currency:searchData.cur,filters:searchData.payload.filters,view:perspective[0]},geoArray=(JSON.parse(searchData.payload.locations).length,_geoPoint.split("/")),tmpLen=geoArray.filter(function(val){return 0!==val&&"0"!==val}).length,geoLen=4===tmpLen&&"micro"===geoArray[3]?tmpLen-1:tmpLen,childLen=geoLen-1,geoName=2===geoLen?HF.utils.codeToName(geoArray[childLen]):geoArray[childLen],cachedLen=searchData.geo.filter(function(val){return 0!==val&&"0"!==val}).length,cachedTmp=cachedLen?HF.results.list.getCached("level"+cachedLen):HF.results.list.getCached("level1"),geoPath="child"===_trigger?_geoPoint:searchData.geo.join("/");return"child"===_trigger?(_gender=cachedTmp.regions[geoName.toLowerCase()].gender,_exp=cachedTmp.regions[geoName.toLowerCase()].explevel,_ethnic=cachedTmp.regions[geoName.toLowerCase()].demographic):(_gender=cachedTmp.overview.gender,_exp=cachedTmp.overview.explevel,_ethnic=cachedTmp.overview.demographic),$.ajax({type:"POST",url:pathApi+"horsefly/"+perspective[0]+"/search/"+geoPath+"/"+perspective[1],data:payload,dataType:"json",crossDomain:!0})}function _showProjection(dataType,dataValue,dataDir){var projectionData=null,timeDir=dataDir||"future";$.when(_fetchProjection(dataType,dataValue,timeDir)).then(function(data){return data?(projectionData=data,HF.views.addModule($elWrapDets,"projection_details",{projectionType:dataType,projectionValue:dataValue})):_errorMsg()}).then(function(done){if(done){_treeDiagram(projectionData,timeDir);var $el=$("#"+elViewWrap);$el.addClass("details"),_eventsDetailBind(),setTimeout(function(){$el.removeClass("loading")},300)}})}function _updateProjection(dataType,dataValue,dataDir){$elWrapDets.addClass("loading"),elTree.destroy(),$("#projection-wrap").empty();var projectionData=null,timeDir=dataDir||"future";$.when(_fetchProjection(dataType,dataValue,timeDir)).then(function(data){data&&(_treeDiagram(projectionData=data,timeDir),setTimeout(function(){$elWrapDets.removeClass("loading")},300))})}function _treeDiagram(data,timeDir){var treeDir="future"===timeDir?"WEST":"EAST",collapseAll=function(jsonObj){for(var len=jsonObj.children.length,i=0;i<len;i++)jsonObj.children[i].collapsed=!0,jsonObj.children[i].children&&collapseAll(jsonObj.children[i])};collapseAll(data);var tree_structure={chart:{container:"#projection-wrap",levelSeparation:40,siblingSeparation:20,subTeeSeparation:20,rootOrientation:treeDir,node:{HTMLclass:"position",drawLineThrough:!1,collapsable:!0},connectors:{style:{"stroke-width":2,stroke:"#686868"}}},nodeStructure:data};elTree=new Treant(tree_structure)}function _fetchProjection(type,value,dir){var searchData=$.extend(!0,{},HF.results.list.getData("searchData")),payload={searchId:HF.results.list.getData("searchId"),trigger:_trigger,timeDirection:dir,input:value},geoPath=searchData.geo.join("/");return $.ajax({type:"GET",url:pathApi+"horsefly/tree/project/"+geoPath+"/"+type,data:payload,dataType:"json",crossDomain:!0})}function _eventsDetailBind(){$elWrapDets.on("click",".time-dir a",function(e){e.preventDefault(),e.stopPropagation();var type=$(this).data("type"),value=$(this).data("value"),time=$(this).data("dir");"past"===time?$(this).closest(".time-dir").removeClass("past").addClass("future"):$(this).closest(".time-dir").removeClass("future").addClass("past"),_updateProjection(type,value,time)}),$elWrapDets.one("click","a.closepane",function(e){e.preventDefault(),e.stopPropagation(),$("#"+elViewWrap).removeClass("details"),setTimeout(function(){_eventsDetailUnbind()},500)})}function _eventsDetailUnbind(){return $elWrapDets.off("click"),elTree.destroy(),elTree=null,$elWrapDets.empty(),!0}function _combinedChart(data){var chartReady=$.Deferred();return elChart=Highcharts.chart(elChartWrap,{chart:{events:{load:function(){$elBreakdown.find('div[class$="-breakdown"]').length?chartReady.resolve(!0):$.when(HF.views.addModule($elBreakdown,"data_breakdown",{gender:_gender,exp:_exp})).then(function(genderReady){chartReady.resolve(genderReady)})}}},title:{text:""},xAxis:{categories:data.xAxisObj},series:data.seriesObj,plotOptions:{series:{stacking:"normal",borderColor:"rgba(0,0,0,0)",borderWidth:0,states:{inactive:{opacity:1}}}},credits:{enabled:!1},exporting:{enabled:!0},navigation:{buttonOptions:{y:-6}},yAxis:[{labels:{style:{color:"#2196F3"}},title:{text:"Candidates",style:{color:"#2196F3"}}},{title:{enabled:!0,text:"Candidates per Role",style:{color:"#000008"}},labels:{style:{color:"#000008"}}},{title:{enabled:!0,text:"Avg Salary",style:{color:"#3bb32b"}},labels:{style:{color:"#3bb32b"}},min:0,opposite:!0}],tooltip:{useHTML:!0,shared:!0,formatter:function(){var i=this.points.length-1,t='<div class="chart-tooltip">';return t+="<big>"+this.x+"</big>","hideLabel"===this.points[i].series.name?(t+='<br /><span style="background-color: #3bb32b;"></span>Avg Salary: ',t+="<b>sourcing</b>"):(t+='<br /><span style="background-color:'+this.points[i].point.color+';"></span>'+this.points[i].series.name+": ",t+="<b>"+Highcharts.numberFormat(this.points[i].point.options.y,0,","," ")+"</b>"),t+="</div>"}}}),chartReady.promise()}function _ethnicityChart(data){function maxFontSizeForWidth(text,width,i){return i=void 0===i?1:i,0===$("#sizeCalculator").length?(mydiv=$('<div id="sizeCalculator" style="font-family: Arial;width: auto;font-size: '+i+'px;position: absolute;visibility: hidden;height: auto;white-space: nowrap;bottom: 0px;">'+text+"</div>"),$("body").append(mydiv)):(mydiv=$($("#sizeCalculator")[0]),mydiv.html(text),mydiv.css("font-size",i+"px")),calculatedWidth=mydiv[0].clientWidth,calculatedWidth>width?i-1:(i++,maxFontSizeForWidth(text,width,i))}function textWithAdaptiveSize(point){point.shapeArgs.height;var labelMaxWidth=point.shapeArgs.width-30,textMaxWidth=maxFontSizeForWidth(point.value,labelMaxWidth);return iFontSize=Math.min(28,textMaxWidth),iFontSize>12?'<div class="tree-label"><span class="value" style="font-size:'+iFontSize+'px;">'+point.value+"%</span><span>"+point.name+"</span></div>":""}var ethnicData=[],ethnicityColor={asian:"#04202c",black:"#00c4aa",east_or_southeast_asian:"#a18051",hispanic:"#4584c4",indigenous:"#4c9059",maori:"#eb5b30",mixed:"#f9a100",not_declared:"#cf4f9a",other:"#7996aa",white:"#765fbb"};for(var key in data)if(data.hasOwnProperty(key)&&"total"!==key&&data[key]){var formattedName=null;formattedName="east_or_southeast_asian"===key?"East or Southeast Asian":"not_declared"===key?"Not declared":key.charAt(0).toUpperCase()+key.slice(1);var percent=100*data[key],rounded=Math.round(100*(percent+Number.EPSILON))/100;ethnicData.push({name:formattedName,value:rounded,color:ethnicityColor[key]})}elEthnic=Highcharts.chart(elEthnicWrap,{title:{text:"Ethnicity Breakdown",style:{fontSize:"16px"}},accessibility:{point:{valueSuffix:"%"}},tooltip:{pointFormat:"{point.name}: <b>{point.value:.2f}%</b>"},plotOptions:{series:{animation:!1},treemap:{allowPointSelect:!0,cursor:"pointer"}},series:[{type:"treemap",layoutAlgorithm:"squarified",data:ethnicData,dataLabels:{enabled:!0,useHTML:!0,allowOverlap:!1,formatter:function(){return textWithAdaptiveSize(this.point)}},legendType:"point",showInLegend:!0}],credits:{enabled:!1},exporting:{enabled:!0},navigation:{buttonOptions:{y:-6}}})}function _simpleChart(data){var chartReady=$.Deferred();return elChart=Highcharts.chart(elChartWrap,{chart:{type:"bar",inverted:!1,events:{load:function(){chartReady.resolve(!0)}}},title:{text:""},xAxis:{categories:data.xAxisObj},series:data.seriesObj,plotOptions:{series:{stacking:"normal",borderColor:"rgba(0,0,0,0)",borderWidth:0,states:{inactive:{opacity:1}}}},credits:{enabled:!1},exporting:{enabled:!0},navigation:{buttonOptions:{y:-6}},yAxis:[{labels:{style:{color:"#000008"},enabled:!1},title:{text:"Frequency",style:{color:"#000008"}}}],tooltip:{useHTML:!0,formatter:function(){return"<b> "+this.x+"</b>"},shared:!0}}),chartReady.promise()}function _demandList(data){var listReady=$.Deferred(),regions=data.regions;if($("#"+elChartWrap).html('<ul id="demand-list" class="data-list"><li class="head"><span class="name">Region Name</span><span class="ratio">Candidates<br />per Role</span><span class="gender">Gender<br />Split</span><span class="exp">Experience<br />Split</span><span class="count">Total<br />Candidates</span><span class="count">Total<br />Adverts</span></li></ul>'),regions)for(var i in regions){var region=regions[i],gen=region.genderCounts?[region.genderCounts.male,region.genderCounts.female]:[0,0],exp=region.experienceCounts?region.experienceCounts:[0,0,0],genTotal=gen[0]+gen[1],expTotal=exp[0]+exp[1]+exp[2],rat=region.regionDifficultyRatio?region.regionDifficultyRatio:"n/a",$list=$("<li />"),adverts=region.advertsCount?HF.utils.addCommas(region.advertsCount):0;$list.html('<span class="name">'+i+'</span><span class="ratio">'+rat+'</span><span class="gender">Male: '+HF.utils.toPercent(gen[0],genTotal,0,!1,!0)+"<br />Female: "+HF.utils.toPercent(gen[1],genTotal,0,!1,!0)+'</span><span class="exp">0-3 y: '+HF.utils.toPercent(exp[0],expTotal,0)+"<br />4-7 y: "+HF.utils.toPercent(exp[1],expTotal,0)+"<br />8+ y: "+HF.utils.toPercent(exp[2],expTotal,0)+'</span><span class="count">'+HF.utils.addCommas(region.candidatesCount)+'</span><span class="count">'+adverts+"</span>"),$("#demand-list").append($list)}return listReady.resolve(!0),listReady.promise()}function _simpleList(data){var listTitle,noDups=data.perspectiveClustersList.filter(function(item,index,self){return index===self.findIndex(function(i){return i.itemTitle===item.itemTitle})}),listReady=$.Deferred(),isProjectable=window.hasTree&&("jobTitles"===perspective[1]||"companies"===perspective[1]);return"schools"===perspective[1]?listTitle="School Name":"jobTitles"===perspective[1]?listTitle="Job Title":"companies"===perspective[1]?listTitle="Company Name":"hardSkills"===perspective[1]&&(listTitle="Keyword"),$("#"+elChartWrap).html('<ul id="perspective-list" class="data-list"><li class="head"><span class="title">'+listTitle+'</span><span class="gender">Male</span><span class="gender">Female</span></li></ul>'),$.each(noDups,function(i,item){var gen=item.genderCounts?[item.genderCounts.male,item.genderCounts.female]:[0,0],genTotal=gen[0]+gen[1],$list=$("<li />"),male=!genTotal||isNaN(gen[0])?"n/a":HF.utils.toPercent(gen[0],genTotal,0,!1,!0),female=!genTotal||isNaN(gen[1])?"n/a":HF.utils.toPercent(gen[1],genTotal,0,!1,!0);isProjectable?$list.html('<span class="title">'+item.itemTitle+'<small><a href="#" data-type= "'+perspective[1]+'" data-value="'+item.itemTitle+'" class="projections is-tooltip"><i class="material-icons">device_hub</i><p class="lft">Projections</p></a></small></span><span class="gender">'+male+'</span><span class="gender">'+female+"</span>"):$list.html('<span class="title">'+item.itemTitle+'</span><span class="gender">'+male+'</span><span class="gender">'+female+"</span>"),$("#perspective-list").append($list)}),listReady.resolve(!0),listReady.promise()}function _errorMsg(){var errorReady=$.Deferred();return $("#"+elChartWrap).html('<div class="msg-box"><p>Data is sparse here, so it is difficult to produce accurate insights.</p><p>Check back soon for updates.</p></div>'),errorReady.resolve(!0),errorReady.promise()}var elViewWrap,$elWrapMain,$elWrapDets,$elBreakdown,$elChartSwitch,$elTabList,elChartWrap,elChart,elEthnicWrap,elEthnic,elTree,_geoPoint,_trigger,_gender,_exp,_ethnic,_configBase=[{viewName:"demand",tabTitle:"supply and demand"},{viewName:"schools",tabTitle:"universities"},{viewName:"jobTitles",tabTitle:"job titles"},{viewName:"companies",tabTitle:"companies"},{viewName:"hardSkills",tabTitle:"keywords"}];return{init:function(el){elViewWrap=el,elChartWrap="perspective-wrap",elEthnicWrap="ethnicity-wrap",$elWrapMain=$("#ext-wrap"),$elWrapDets=$("#ext-details"),$elBreakdown=$("#demographics"),$elChartSwitch=$("#perspective-switch"),$elTabList=$("#tabs-wrapper").children(".tabs"),perspective[2]="candidates","list"===perspective[0]&&$elWrapMain.find("a.switch-view").removeClass("list"),$.when(_eventsBind()).then(function(binded){if(binded)return _getChartData()}).then(function(charted){charted&&($("#"+el).addClass("candidates"),setTimeout(function(){$("#"+el).removeClass("loading")},300))})},getData:function(geoPoint,geoName,trigger){return _getBaseData(geoPoint,geoName,trigger)},unload:function(){var isUnload=$.Deferred(),$el=$("#"+elViewWrap);return $el.removeClass("candidates"),$.when(_eventsUnbind()).then(function(unbinded){unbinded&&($el.addClass("on-back").empty(),elViewWrap=null,extNow.length=0,isUnload.resolve(unbinded))}),isUnload.promise()}}}(),HF.wammee=function(){function _eventsBind(){return elWrapMain.on("click","a.backbtn",function(e){e.preventDefault(),e.stopPropagation(),_eventsUnbind();var $el=$("#"+elViewWrap);$el.removeClass("wammee"),setTimeout(function(){tinymce.remove("textarea#description"),$el.addClass("on-back").empty(),elViewWrap=null,extNow.length=0},500)}),elForm.on("change",'input[name="applicationType"]',function(){"0"===$("input[name=applicationType]:checked").val()?($("#atsURL").prop("disabled",!0),$("#atsURL").next("span").attr("class","initial").empty(),$("#atsEmail").prop("disabled",!1)):($("#atsEmail").prop("disabled",!0),$("#atsEmail").next("span").attr("class","initial").empty(),$("#atsURL").prop("disabled",!1))}),elSendBtn.on("click",function(e){if(e.preventDefault(),e.stopPropagation(),$(this).hasClass("disabled"))return!1;_validateForm()}),elForm.on("keyup","input",_debounce(function(){_validate($(this).attr("id"),$(this).val())},600)),!0}function _eventsUnbind(){return _destroySelects(),elWrapMain.off("click"),elForm.off("change",'input[name="applicationType"]'),elForm.off("keyup","input"),elSendBtn.off("click"),elWrapMain=null,elForm=null,elSendBtn=null,!0}function _initEditor(){var isRender=$.Deferred();return tinymce.init({selector:"textarea#description",resize:!1,height:180,max_height:500,menubar:!1,plugins:"paste",toolbar:"bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist | paste",paste_as_text:!0,paste_convert_word_fake_lists:!0,paste_word_valid_elements:"b,strong,i,em,u,ul,ol,li",branding:!1,init_instance_callback:function(editor){isRender.resolve(!0)}}),isRender.promise()}function _debounce(func,wait,immediate){var timeout;return function(){var context=this,args=arguments,callNow=immediate&&!timeout;clearTimeout(timeout),timeout=setTimeout(function(){timeout=null,immediate||func.apply(context,args)},wait),callNow&&func.apply(context,args)}}function _validate(id,val){var $this=$("#"+id);if("wammee_title"===id&&(val?$this.next("span").attr("class","valid").empty():_setError($this,"Position name is empty")),"wammee_salary"===id&&(val?$this.next("span").attr("class","valid").empty():_setError($this,"Salary is empty")),"atsEmail"===id){var regEmail=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;val?regEmail.test(val)?$this.next("span").attr("class","valid").empty():_setError($this,"Email address format is invalid"):_setError($this,"Application method is empty")}if("atsURL"===id){var regUrl=/^((https?:\/\/)?([^\s\W][\w\-]{1,}\.){0,2}([\w]{2,})(\.[\w]{2,14})?(\.[\w]{2,14}\/?)([\w\?\=\.\#\!\@\&\-\/]{2,}[^\.\s\,])*)$/;val?regUrl.test(val)?$this.next("span").attr("class","valid").empty():_setError($this,"URL format is invalid"):_setError($this,"Application method is empty")}elSendBtn.toggleClass("disabled",elForm.find("span.valid").length<3)}function _validateForm(){$.when(_validateDescription()).then(function(valid){valid&&4===elForm.find("span.valid").length&&elForm.submit()})}function _validateDescription(){tinymce.EditorManager.triggerSave();var isValid,$this=$("#description");return $this.val()?($this.next("span").attr("class","valid").empty(),isValid=!0):(_setError($this,"Description is empty"),isValid=!1),isValid}function _setError($this,msg){$this.next("span").hasClass("error")?$this.next("span").text(msg):$this.next("span").attr("class","error").text(msg)}function _createSelects(){["hireType","hours"].forEach(function(itemSel){$("#"+itemSel).selectize({disableDelete:!0,onInitialize:function(){ddList[itemSel]=$(this)[0]}})})}function _destroySelects(){var isDestroyed=$.Deferred();if(HF.utils.isEmptyObj(ddList))isDestroyed.resolve(!1);else{for(var key in ddList)ddList.hasOwnProperty(key)&&(ddList[key].destroy(),delete ddList[key]);isDestroyed.resolve(!0)}return isDestroyed.promise()}var elViewWrap,elWrapMain,elForm,elSendBtn,ddList={};return{init:function(el){_createSelects(),errorCount=0,elViewWrap=el,elWrapMain=$("#ext-wrap"),elForm=$("#form-campaign-preview"),elSendBtn=$("#campaign-apply-btn"),$.when(_eventsBind()).then(function(binded){return _initEditor()}).then(function(ready){ready&&($("#"+elViewWrap).addClass("wammee"),setTimeout(function(){$("#"+elViewWrap).removeClass("loading")},300))})},getData:function(geoPoint,trigger){var geoData=HF.results.list.getData("searchData","geo");return{searchId:HF.results.list.getData("searchId"),country:geoData[1],candidates:HF.results.list.getData("wammeeCount"),credits:Math.ceil(HF.results.list.getData("wammeeCount")/5e3)}},unload:function(){var isUnload=$.Deferred(),$el=$("#"+elViewWrap);return $el.removeClass("wammee"),$.when(_eventsUnbind()).then(function(unbinded){unbinded&&(tinymce.remove("textarea#description"),$el.addClass("on-back").empty(),elViewWrap=null,extNow.length=0,isUnload.resolve(unbinded))}),isUnload.promise()}}}(),HF.results=function(){function _eventsBind(subview){$elContent=$("#base-contents"),elMainWrap=$elContent.closest("section").attr("id")}function _eventsUnbind(){$elContent=null,elMainWrap=null}var $elContent,elMainWrap,baseID="results";return{init:function(subView){_eventsBind(subView),events.emit("doneLoading",elMainWrap)},getData:function(type){return!1},unload:function(subview){var baseUnload=$.Deferred();return $.when(HF[baseID].list.unload("all")).then(function(viewUnload){viewUnload&&(_eventsUnbind(),baseUnload.resolve(viewUnload))}),baseUnload.promise()}}}(),HF.results.list=function(){function _eventsBind(){return elItem.on("click","a.backbtn",function(e){e.preventDefault(),e.stopPropagation();var target=$(this).data("target");if(extNow.length>0){var prevView=extNow[0];HF[prevView].unload()}if("results"===target){var levelTarget=0,levelCurrent=_getLevel();4===levelCurrent&&"micro"===_config.searchData.geo[3]?(levelTarget=levelCurrent-3,_config.searchData.geo=[0,0,0,0]):(levelTarget=levelCurrent-1,_config.searchData.geo[levelTarget]=0),HF.views.set("results","level"+levelTarget,elViewWrap)}"search"===target&&(events.emit("cleanMap"),HF.views.set("search","build"))}),elItem.on("click","a.toggle-map",function(e){e.preventDefault(),e.stopPropagation(),$("#alt").addClass("showing")}),elGeoItem.on("click",function(e){e.preventDefault(),e.stopPropagation();var parentLi=$(this).parent(),parentUl=parentLi.parent(),viewType=parentLi.attr("class"),geoPoint=parentUl.data("geopoint"),geoName=parentUl.data("geoname");HF.views.setDetails(viewType,geoPoint,geoName,"parent","ext")}),elCardItem.on("click","a.geopoint",function(e){e.preventDefault(),e.stopPropagation();$(this).text();var geoArray=$(this).next("ul").data("geopoint").split("/"),level=geoArray.filter(function(val){return 0!==val&&"0"!==val}).length;_config.searchData.geo=geoArray,HF.views.set("results","level"+level,elViewWrap)}),elCardItem.on("click","small.help",function(e){HF.views.modal({modalurl:"sourcing",bgclose:!1,isinfo:!0})}),elGeoList.on("click",function(e){e.preventDefault(),e.stopPropagation();var parentLi=$(this).parent(),parentUl=parentLi.parent(),viewType=parentLi.attr("class"),geoPoint=parentUl.data("geopoint"),geoName=parentUl.data("geoname");HF.views.setDetails(viewType,geoPoint,geoName,"child","ext")}),elSalaryOpt.on("change",function(e){var isChecked=this.checked;$("#base-contents").toggleClass("show-rate",isChecked)}),$("#base-contents").hasClass("show-rate")&&elSalaryOpt.prop("checked",!0),!0}function _eventsUnbind(){elItem.off("click"),elGeoItem.off("click"),elCardItem.off("click"),elGeoList.off("click"),elSalaryOpt.off("change"),elViewWrap=null,elItem=null,elList=null,elGeoItem=null,elCardItem=null,elGeoList=null,elSalaryOpt=null}function _getContext(){var ctxReady=$.Deferred();return _tempMax=0,$.when(_fetchResults()).then(function(data){ctxReady.resolve(data)}),ctxReady.promise()}function _getGeoData(geoArray){var name,code,searchData=geoArray||_config.searchData.geo,len=searchData.filter(function(val){return 0!==val&&"0"!==val}).length;return 0===len?(name="Worldwide",code="world",len=1):2===len?(code=searchData[len-1],name=HF.utils.codeToName(code)):3===len&&"all"===searchData[len-1]?(code=searchData[len-2],name=HF.utils.codeToName(code)):(code=searchData[len-1],name=HF.utils.capAll(code)),[len,name,code]}function _fetchResults(){var isFirst=!_config.searchId,geoJson=[{subContinent:_config.searchData.geo[0],country:_config.searchData.geo[1],region:_config.searchData.geo[2],city:_config.searchData.geo[3],locationId:0,radius:""}],geoPath=isFirst?_config.searchData.payload.locations:JSON.stringify(geoJson),geoCur=_config.searchData.cur,payload=isFirst?_config.searchData.payload:{searchId:_config.searchId,tags:_config.searchData.payload.tags,locations:geoPath,currency:geoCur,filters:_config.searchData.payload.filters,token:"xtempx"},geoData=_getGeoData(),geoLevel="level"+geoData[0],geoName=_config.locations>1?null:geoData[1];return!HF.utils.isEmptyObj(geoLevel)&&_cached.hasOwnProperty(geoLevel)?(events.emit("resultsReady",geoLevel),_cached[geoLevel]):$.ajax({type:"POST",url:apiListSearch+"demand",data:payload,dataType:"json",crossDomain:!0,dataFilter:function(data){var parsed=JSON.parse(data);if(!HF.utils.isEmptyObj(parsed)){isFirst&&(_config.searchId=parsed.searchId,_config.wammeeCount=parsed.wammeeCandidatesCount),parsed.multiCountry&&(geoName=parsed.countryCount>1?"Multiple Locations":HF.utils.codeToName(parsed.countryCollection[0])),_cached[geoLevel]={overview:{},regions:{},maxTotal:0};var regions=parsed.regions;for(var key in regions)if(regions.hasOwnProperty(key)){if(!geoName){var tmpGeoTemp=_getGeoData(regions[key].originalLocation.geoPath.split("/"));geoName=tmpGeoTemp[1]}var regionOpt="city"===regions[key].focusLevel?"deepest":"goDeep";if(key.indexOf(" Plus ")>-1){var tmpKey=regions[key].regionName;_cached[geoLevel].regions[tmpKey]=_mapResults(key,regions[key],geoCur,regionOpt,!0)}else _cached[geoLevel].regions[key]=_mapResults(key,regions[key],geoCur,regionOpt,!1)}delete parsed.regions;var overviewOpt=isFirst?"isFirst":"subsequent",geoFormated=isFirst&&_config.searchData.rad?geoName+" ("+_config.searchData.rad+" mi. radius)":geoName;_cached[geoLevel].overview=_mapResults(geoFormated,parsed,geoCur,overviewOpt,!1)}return _cached[geoLevel].maxTotal=_tempMax,events.emit("resultsReady",geoLevel),JSON.stringify(_cached[geoLevel])},success:function(results){return results}})}function _mapResults(key,data,cur,opts,isMicroRegion){var isOverview="goDeep"!==opts&&"deepest"!==opts,locId=isOverview?data.parentLocationId:data.locationId,locPath=null,salMax=isOverview?data.totalMaxSalary:data.maxSalary,gen=(isOverview?data.originalTotalCandidatesCount:data.originalCandidatesCount,isOverview?data.totalGenderCounts:data.genderCounts),job=isOverview?data.totalAdvertsCount:data.advertsCount,exp=isOverview?data.totalExperienceCounts:data.experienceCounts,dem=null;if(_tempMax=salMax>_tempMax?salMax:_tempMax,isOverview)locPath="0/0/0/0",void 0!==data.totalEthnicityBreakDown&&data.totalEthnicityBreakDown&&(dem=data.totalEthnicityBreakDown);else{if("region"===data.focusLevel){var microPrefix=isMicroRegion?"micro":0;locPath=data.originalLocation.subContinent+"/"+data.originalLocation.country+"/"+data.regionName+"/"+microPrefix}else if("city"===data.focusLevel){var dataLoc=data.originalLocation,dataRegion="0"===dataLoc.region?"all":dataLoc.region;locPath=dataLoc.subContinent+"/"+dataLoc.country+"/"+dataRegion+"/"+data.cityName}else locPath=data.originalLocation.geoPath;void 0!==data.demographic&&data.demographic&&(dem=data.demographic)}return{candidates:isOverview?data.totalCandidatesCount:data.candidatesCount,currency:cur,explevel:[exp[0],exp[1],exp[2],exp[0]+exp[1]+exp[2]],gender:gen?[gen.female,gen.male,gen.female+gen.male]:[0,0,0],demographic:dem,locationId:locId||key.replace(/\s/g,"").toLowerCase(),jobposts:job||0,levelOpts:opts,location:key,locationPath:locPath,mapType:isOverview?data.mapType:[data.lon,data.lat],salary:{min:isOverview?data.totalMinSalary:data.minSalary,avg:isOverview?data.totalAvgSalary:data.avgSalary,max:isOverview?data.totalMaxSalary:data.maxSalary},rate:{min:dailyRate(isOverview?data.totalMinSalary:data.minSalary),avg:dailyRate(isOverview?data.totalAvgSalary:data.avgSalary),max:dailyRate(isOverview?data.totalMaxSalary:data.maxSalary)}}}function dailyRate(salary){return window.rateEnabled?Math.round(65+.0095*salary):0}function _getLevel(){var len=_config.searchData.geo.filter(function(val){return 0!==val&&"0"!==val}).length;return parseInt(len)}function _resolveCacheClean(type){var isClean=$.Deferred();return type&&"all"===type?isClean.resolve(cleanCached()):type&&"all"!==type&&Object.keys(_cached).length>1&&_cached.hasOwnProperty(type)?isClean.resolve(cleanCached(type)):isClean.resolve(!0),isClean.promise()}function cleanCached(objKey){var isClean=$.Deferred();if(objKey)_cached.hasOwnProperty(objKey)&&delete _cached[objKey],isClean.resolve(!0);else{for(var key in _cached)_cached.hasOwnProperty(key)&&delete _cached[key];isClean.resolve(!0)}return isClean.promise()}var elViewWrap,elItem,elList,elGeoItem,elCardItem,elGeoList,elSalaryOpt,apiListSearch=pathApi+"horsefly/list/search/",_config={searchId:0,wammeeCount:0,locations:0,searchData:{}},_cached={},_tempMax=0;return events.on("searchSetup",function(searchObj){_config.searchData=searchObj;var locs=JSON.parse(_config.searchData.payload.locations);_config.searchData.geo=1===locs.length?[locs[0].subContinent,locs[0].country,locs[0].region,locs[0].city]:[0,0,0,0],_config.locations=locs.length;var level=_getLevel();HF.views.set("results","level"+level,"key")}),events.on("mapDrilled",function(data){data[0];var geoArray=data[1].split("/"),level=geoArray.filter(function(val){return 0!==val&&"0"!==val}).length;_config.searchData.geo=geoArray,HF.views.set("results","level"+level,elViewWrap)}),{init:function(el){elViewWrap=el,elItem=$("#"+el).find("#result-item"),elList=$("#"+el).find("#result-list"),elGeoItem=elItem.find("li > a"),elCardItem=elList.find(".card-item"),elGeoList=elCardItem.find("li > a"),elSalaryOpt=$("#switch"),$.when(HF.dropdownList.init("nav-wrapper","searchOpt"),_eventsBind()).then(function(added,binded){binded&&events.emit("doneLoading",elViewWrap)})},getData:function(type,subtype){return type?subtype?_config[type][subtype]:_config[type]:_getContext()},getCached:function(objKey){return objKey?_cached[objKey]:_cached},cleanCached:cleanCached,unload:function(type){var isUnload=$.Deferred();return _eventsUnbind(),$.when(HF.dropdownList.unload("nav-wrapper"),_resolveCacheClean(type)).then(function(unloaded,cleaned){if(unloaded&&cleaned)if("all"===type){_config.searchId=0,_config.wammeeCount=0;for(var key in _config.searchData)_config.searchData.hasOwnProperty(key)&&delete _config.searchData[key];isUnload.resolve(!0)}else isUnload.resolve(!0)}),isUnload.promise()}}}(),HF.selects=function(){function getCurrencies(){return _currency.map(function(cur){return{code:cur.code,symbol:cur.symbol,name:cur.id}})}function _fetchCountries(){return $.ajax({type:"POST",url:pathApi+"horsefly/users/testAccessCountries",dataType:"json",data:{token:"xtempx"},crossDomain:!0,dataFilter:function(data){var parsed=JSON.parse(data),countries=parsed.filter(function(country){return null!==country});return JSON.stringify(countries)},success:function(results){return results}})}function _createAll(){var created=$.Deferred();return $.when(_fetchCountries()).then(function(cc){var currency=(_country=cc.map(function(item1){return item1.currency=_country.find(function(item2){return item2.code===item1.code}).currency,item1})).map(function(country){return country.currency});_currency=_currency.filter(function(item){return currency.includes(item.id)}),selConf.currency.options=getCurrencies(),_createEach("currency"),created.resolve(!0)}),created.promise()}function _createEach(selName){$("#search_"+selName).selectize(selConf[selName])}function _destroy(selName){listSel[selName].destroy(),delete listSel[selName]}var listSel={},selConf={currency:{valueField:"name",labelField:"code",searchField:"code",options:[],disableDelete:!0,render:{item:function(item,escape){return"<div>"+escape(item.code)+" "+escape(item.symbol)+"</div>"},option:function(item,escape){return"<div>"+(item.code?"<strong>"+escape(item.code)+"</strong>":"")+(item.symbol?" "+escape(item.symbol):"")+"</div>"}},onChange:function(value){HF.search.build.setData("cur",this.options[value].name)},onInitialize:function(){listSel.currency=$(this)[0]}}};return{init:function(){var completed=$.Deferred();return $.when(_createAll(),HF.search.build.getData("searchData")).then(function(created,data){created&&data&&(listSel.currency.setValue(data.cur),completed.resolve(created))}),completed.promise()},clean:function(){return HF.utils.isEmptyObj(listSel)||listSel.currency.setValue("pound"),!0},destroyAll:function(){var isDestroyed=$.Deferred();if(HF.utils.isEmptyObj(listSel))isDestroyed.resolve(!1);else{for(var key in listSel)listSel.hasOwnProperty(key)&&_destroy(key);isDestroyed.resolve(!0)}return isDestroyed.promise()},destroySel:function(selItem){var isDestroyed=!1;return selItem&&(HF.utils.isEmptyObj(listSel)||listSel.hasOwnProperty(selItem)&&(_destroy(selItem),isDestroyed=!0)),isDestroyed}}}(),HF.tags=function(){function addGroup(elWrap,groupID,data){var isReady=$.Deferred(),$elWrap=$("#"+elWrap);return $mainWrap||($mainWrap=$elWrap),$.when(HF.views.addModule($elWrap,"tag_group",{groupId:groupID})).then(function(rendered){if(rendered)return _createTags(groupID,data)}).then(function(created){if(created)return _eventsBind("tag-group-"+groupID)}).then(function(binded){data||_canExclude(),isReady.resolve(binded)}),isReady.promise()}function _createTags(groupID,data){var items;if(data){if(!data.include){var group=$("#tag-group-"+groupID);group.addClass("excluding"),group.find(".toggle-input").prop("checked",!1)}items=data.keywords.map(function(item){return item.keyword})}var isCreated=$.Deferred();return $("#tag-list-"+groupID).selectize({plugins:["remove_button","drag_drop"],delimiter:",",persist:!1,openOnFocus:!1,closeAfterSelect:!0,openAfterItemRemove:!1,options:data?data.keywords:[],items:items||[],valueField:"keyword",labelField:"keyword",searchField:"keyword",render:{item:function(tag,escape){return'<span data-value="'+tag.keyword+'" data-type="'+tag.type+'">'+escape(tag.keyword)+"</span>"}},score:function(search){var ignore=search&&search.length<1,score=this.getScoreFunction(search);return function(item){return ignore?0:score(item)}},createFilter:function(input){var minLen=(input=input.toLowerCase()).length>1,options=this.options,isOption=!0,isUnique=0===$.grep(this.getValue(),function(value){return value.toLowerCase()===input}).length;for(var key in options)if(input===key)return isOption=!1;return!!(minLen&&isUnique&&isOption)},create:function(input,callback){if(this.preload=!0,noiseWords.indexOf(input)>-1)return HF.views.modal({modalurl:"noisewords",bgclose:!1,isinfo:!0}),!1;callback({keyword:input,type:"unknown"})},load:function(query,callback){if(!query.length)return this.close();var self=this;$.ajax({type:"GET",url:apiKeywords+encodeURIComponent(query),success:function(res){self.preload?callback():callback(res.slice(0,10)),self.preload=!1},error:function(){callback(),self.preload=!1}})},onItemAdd:function(value,$item){return this.close()},onDelete:function(values){if(values.length>1)return confirm("Are you sure you want to remove these "+values.length+" tags?")},onItemRemove:function(value){return this.close()},onFocus:function(){var elID=$(this.$input).parent().attr("id"),container=$("#"+elID).children(".tag-suggestions");$mainWrap.find(".tag-suggestions").removeClass("open"),container.addClass("open")},onBlur:function(){return this.close()},onDropdownClose:function(option){return this.clearOptions()},onChange:function(value){var elID=$(this.$input).parent().attr("id");_getSuggestions(elID),_checkGroupsStatus(elID,!1),this.clearOptions(),this.close()},onInitialize:function(){listTags["tag-group-"+groupID]=$(this)[0],isCreated.resolve(!0)}}),isCreated.promise()}function _getGroupTags(elID){for(var isCreated=$.Deferred(),groupOpts=[],i=0;i<listTags[elID].items.length;i++){var item=listTags[elID].items[i];groupOpts.push(listTags[elID].options[item])}var groupTags=groupOpts.map(function(item){return{keyword:item.keyword,type:item.type}});return isCreated.resolve(groupTags),isCreated.promise()}function _fetchSuggestions(tagsExisting){return $.ajax({type:"POST",url:apiSuggests,data:{tags:JSON.stringify(tagsExisting),token:"xtempx"},dataType:"json",crossDomain:!0}).promise()}function _parseSuggestions(elID,tags){var container=$("#"+elID).children(".tag-suggestions");if(tags&&tags.length&&(1!==tags.length||tags[0].keyword))for(var i=0;i<tags.length;i++){var tag=tags[i];$("<a/>").text(tag.keyword).attr({href:"#",class:"tag","data-type":tag.type,"data-value":tag.keyword}).appendTo(container)}else $("<span/>").text("No suggestions found").appendTo(container);$mainWrap.find(".tag-suggestions").removeClass("open"),container.addClass("open")}function _getSuggestions(elID){$("#"+elID).children(".tag-suggestions").empty(),$.when(_getGroupTags(elID)).then(function(groupTags){return!!groupTags.length&&_fetchSuggestions(groupTags)}).done(function(suggestions){suggestions&&_parseSuggestions(elID,suggestions)})}function _eventsBind(groupID){var $elGroup=$("#"+groupID),$elSuggest=$elGroup.children(".tag-suggestions"),$toggleBtn=$elGroup.find(".toggle-input"),$removeBtn=$elGroup.find("a.link");return $mainWrap.toggleClass("single-child",$mainWrap.children().length<2),$removeBtn.on("click",function(e){e.preventDefault(),e.stopPropagation(),_destroyGroup(groupID,!0)}),$toggleBtn.on("change",function(e){var targetId=$(this).attr("id").replace("toggle","group");$("#"+targetId).toggleClass("excluding",!this.checked)}),$elSuggest.on("click","a.tag",function(e){e.preventDefault(),e.stopPropagation();var tag={keyword:$(this).data("value"),type:$(this).data("type")},sel=listTags[groupID];sel.addOption(tag),sel.addItem(tag.keyword)}),!0}function _destroyGroup(groupID,isClick){var $elGroup=$("#"+groupID),$toggleBtn=$elGroup.find(".toggle-input");$elGroup.find("a.link").off("click"),$toggleBtn.off("change"),$elGroup.remove(),listTags[groupID].destroy(),delete listTags[groupID],isClick&&_checkGroupsStatus(groupID,isClick)}function _checkGroupsStatus(elID,isClick){var groupsLen,itemsLen,status;if(listTags.constructor===Object&&(groupsLen=Object.keys(listTags).length,itemsLen=isClick?0:listTags[elID].items.length),!isClick&&groupsLen<2)$mainWrap.addClass("single-child"),status=itemsLen?"canAdd":"noSearch";else for(var key in listTags)if(listTags.hasOwnProperty(key)&&key!==elID){if(!listTags[key].items.length){status="isEmpty",isClick||itemsLen?isClick&&(1===groupsLen?(status="noSearch",$mainWrap.addClass("single-child")):status="isEmpty"):(_destroyGroup(key,!1),2===groupsLen?(status="noSearch",$mainWrap.addClass("single-child")):status="isEmpty");break}isClick?(status="canAdd",$mainWrap.toggleClass("single-child",groupsLen<2)):status=itemsLen?"canAdd":"isEmpty"}_canExclude(status),events.emit("groupStatus",status)}function _canExclude(status){var _status=status||"nostatus",isDefaultEmpty=!1,enable=!1,itm=[],len=0;listTags.constructor===Object&&(len=(itm=Object.keys(listTags)).length),$("#"+itm[0]).addClass("defaultGroup"),listTags[itm[0]]&&(isDefaultEmpty=!listTags[itm[0]].items.length),enable=1!==len&&(2===len?"canAdd"===_status:"isEmpty"!==_status||!isDefaultEmpty||"defaultEmpty");for(var key in listTags)if(listTags.hasOwnProperty(key)){var toggleId=key.replace("group","toggle"),$target=$("#"+toggleId),isFirst=$("#"+key).hasClass("defaultGroup");if(enable){if("defaultEmpty"===enable&&!isFirst){$target.prop({checked:!0,disabled:!0}).change();break}$target.prop("disabled",!1).change()}else $target.prop({checked:!0,disabled:!0}).change()}}var $mainWrap,apiKeywords=pathApi+"suggestions/keywords?keyword=",apiSuggests=pathApi+"suggestions/nearKeywords",noiseWords=["a","about","after","all","also","an","another","any","are","as","and","at","be","because","been","before","being","between","but","both","by","came","can","come","could","did","do","each","even","for","from","further","furthermore","get","got","has","had","he","have","her","here","him","himself","his","how","hi","however","i","if","in","into","is","it","its","indeed","just","like","made","many","me","might","more","moreover","most","much","must","my","never","not","now","of","on","only","other","our","out","or","over","said","same","see","should","since","she","some","still","such","take","than","that","the","their","them","then","there","these","therefore","they","this","those","through","to","too","thus","under","up","very","was","way","we","well","were","what","when","where","which","while","who","will","with","would"],listTags={};return{addGroup:addGroup,getGroup:function(id){var isReady=$.Deferred();return listTags[id]?isReady.resolve(listTags[id]):isReady.resolve(!1),isReady.promise()},setGroups:function(elWrap,allData){var isPopulated=$.Deferred(),dataLen=allData.length-1;return allData.forEach(function(data,i){$.when(addGroup(elWrap,i,data)).then(function(done){done&&$("#tag-group-"+i).removeClass("loading")}),i===dataLen&&(_canExclude(),isPopulated.resolve(!0))}),isPopulated.promise()},getBool:function(){var isCreated=$.Deferred(),searchObj=[];if(listTags.constructor===Object&&Object.keys(listTags).length)for(var key in listTags)if(listTags.hasOwnProperty(key)&&listTags[key].items.length){for(var isInclude=$("#"+key).hasClass("excluding")?0:1,options=[],i=0;i<listTags[key].items.length;i++){var item=listTags[key].items[i];options.push(listTags[key].options[item])}var group=options.map(function(item){return{keyword:item.keyword,type:item.type}});searchObj.push({include:isInclude,keywords:group})}return isCreated.resolve(searchObj),isCreated.promise()},resetAll:function(elWrap,groupID){var isReset=$.Deferred();if(HF.utils.isEmptyObj(listTags))isReset.resolve(!1);else{for(var key in listTags)listTags.hasOwnProperty(key)&&_destroyGroup(key,!1);elWrap?$.when(addGroup(elWrap,groupID)).then(function(added){added&&(events.emit("groupStatus","noSearch"),$("#"+elWrap).addClass("single-child")),isReset.resolve(added)}):($mainWrap=null,isReset.resolve(!0))}return isReset.promise()}}}(),HF.map=function(){function _renderMapBox(){var isLoaded=$.Deferred();return mapboxgl.accessToken="pk.eyJ1IjoibWFwdXBqdHciLCJhIjoiY2lmbW9kM3MxMDE4ZHVlbHl3bDN2a2dsOSJ9.Mea9-MfQVZ_6XJM9bjuVMQ",(elMap=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/light-v9",center:[-1,53],minZoom:1,zoom:2,attributionControl:!1,preserveDrawingBuffer:!0})).on("load",function(){isLoaded.resolve(!0),_goToCountry("uk"),elMap.addControl(new mapboxgl.NavigationControl,"top-left"),elPop=new mapboxgl.Popup({closeButton:!1})}),isLoaded.promise()}function _updateSource(mapData){var maxCount,results=$.extend(!0,{},HF.results.list.getCached(mapData)),searchData=HF.results.list.getData("searchData"),geoBound=new mapboxgl.LngLatBounds,filterID=["in","id"],geoPoint=[],stopsArr=[],hasGeometry=!results.overview.mapType,mapID="level2"===mapData?_mapID[mapData]:_mapID[searchData.geo[1]+"_level3"],layerSrc="level2"===mapData?results.overview.locationId+"_"+mapData:results.overview.locationId+"_level3";if(!HF.utils.isEmptyObj(results.regions)){for(var loc in results.regions){maxCount||(maxCount=results.regions[loc].candidates);var region=results.regions[loc],ratio=region.candidates/(10*maxCount)*6;if(!hasGeometry){var geoFeat={type:"Feature",properties:{id:region.locationId,displayName:region.location},geometry:{type:"Point",coordinates:region.mapType}};geoPoint.push(geoFeat),geoBound.extend(region.mapType)}elPopData[region.locationId]={candidates:HF.utils.addCommas(region.candidates),jobposts:HF.utils.addCommas(region.jobposts),salary:region.salary.avg?HF.utils.addCommas(region.salary.avg,results.overview.currency):0,level:region.levelOpts,geoPath:region.locationPath},filterID.push(region.locationId),stopsArr.push([region.locationId,_setColor(ratio)])}if(hasGeometry)$.when(_getBounds(mapData,searchData.geo[1],results.overview.locationId)).then(function(data){for(var key in data.bounds)if(data.bounds.hasOwnProperty(key)&&filterID.indexOf(key)>-1){var templl=new mapboxgl.LngLatBounds(data.bounds[key][0],data.bounds[key][1]);geoBound.extend(templl)}elMap.fitBounds(geoBound,{padding:20})}),elMap.addSource("regions",{type:"vector",url:"mapbox://mapupjtw."+mapID}),_addLayerFill("region",layerSrc,filterID,stopsArr),_addLayerFill("region-hover",layerSrc,filterID,stopsArr);else{var geoJson={type:"FeatureCollection",features:geoPoint};elMap.fitBounds(geoBound,{padding:60,maxZoom:11}),elMap.addSource("regions",{type:"geojson",data:geoJson}),_addLayerCircle("region",filterID,stopsArr),_addLayerCircle("region-hover",filterID,stopsArr)}elLegend.hasClass("hidden")&&(elLegend.on("click",".toggle-btn",_toggleLegend),elLegend.removeClass("hidden").addClass("open")),elHideMap.on("click",_hideMapView),elMap.on("mousemove","region",_popMove),elMap.on("mouseleave","region",_popLeave),elMap.on("click","region",_popClick)}}function _setColor(ratio){var val=ratio>.6?.6:ratio;return val<=.1?"hsl("+Math.ceil(320*val)+", "+Math.ceil(90)+"%, "+Math.ceil(50)+"%)":val>.1&&val<=.35?"hsl("+Math.ceil(23+120*val)+", "+Math.ceil(90)+"%, "+Math.ceil(50)+"%)":"hsl("+Math.ceil(4+180*val)+", "+Math.ceil(100-val*(80*val))+"%, "+Math.ceil(67-48*val)+"%)"}function _addLayerFill(layerId,layerSrc,filter,stops){elMap.addLayer({id:layerId,type:"fill",source:"regions","source-layer":layerSrc,paint:{"fill-color":{property:"id",type:"categorical",stops:stops,default:"rgba(0, 0, 0, 0)"},"fill-outline-color":"region"===layerId?"#282828":"#000000","fill-opacity":"region"===layerId?.8:.9},filter:"region"===layerId?filter:["==","id",""]},"bridge-motorway-2")}function _addLayerCircle(layerId,filter,stops){elMap.addLayer({id:layerId,type:"circle",source:"regions",paint:{"circle-color":{property:"id",type:"categorical",stops:stops,default:"rgba(0, 0, 0, 0)"},"circle-radius":{type:"exponential",stops:[[1,10],[22,4]]},"circle-opacity":"region"===layerId?.8:.9},filter:"region"===layerId?filter:["==","id",""]},"bridge-motorway-2")}function _popMove(e){var feat=e.features[0].properties,salary=elPopData[feat.id].salary?"<li>Avg. Salary: "+elPopData[feat.id].salary+"</li>":"",drillMsg="goDeep"===elPopData[feat.id].level?"<span>Click to drill down</span>":"";elMap.getCanvas().style.cursor="pointer",elMap.setFilter("region-hover",["==","id",feat.id]),elPop.setLngLat(e.lngLat).setHTML("<div id='popup' class='popup' style='z-index: 10;'><h5>"+feat.displayName+"</h5><ul><li>Candidates: "+elPopData[feat.id].candidates+"</li><li>Adverts: "+elPopData[feat.id].jobposts+"</li>"+salary+"</ul>"+drillMsg+"</div>").addTo(elMap)}function _popLeave(){elMap.getCanvas().style.cursor="",elPop.remove(),elMap.setFilter("region-hover",["==","id",""])}function _popClick(e){var feat=e.features[0].properties,name=feat.displayName.toLowerCase(),lvl=elPopData[feat.id].level,geo=elPopData[feat.id].geoPath;"goDeep"===lvl&&events.emit("mapDrilled",[name,geo])}function _toggleLegend(e){e.preventDefault(),e.stopPropagation(),$(e.target).closest(".legend").toggleClass("open")}function _hideMapView(e){e.preventDefault(),e.stopPropagation(),elMapWrap.removeClass("showing")}function _goToCountry(code){_cc=code,elMap.setMaxBounds(null),elMap.fitBounds(_ccBound[code],{padding:20}),elMap.once("moveend",function(e){var tmp=elMap.getBounds();tmp._sw.lng,tmp._sw.lat,tmp._ne.lng,tmp._ne.lat})}function _getBounds(level,country,locId){var pathUrl="level2"===level?"/level2/"+locId+".json":"/level3/"+country+"/"+locId+".json";return $.ajax({type:"GET",url:"https://s3.eu-west-2.amazonaws.com/horsefly-dev/bounds"+pathUrl,dataType:"json",crossDomain:!0})}function _cleanMap(){var isClean=$.Deferred(),mapSource=elMap.getSource("regions");return elMapData&&mapSource?(elMap.off("mousemove","region",_popMove),elMap.off("mouseleave","region",_popLeave),elMap.off("click","region",_popClick),elMap.removeLayer("region"),elMap.removeLayer("region-hover"),elMap.removeSource("regions"),elPopData.length=0,elMapData=null,isClean.resolve(!0)):isClean.resolve(!0),isClean.promise()}var elMapWrap,elMap,elPop,elLegend,elHideMap,elMapData,_cc,elPopData=[];events.on("resultsReady",function(src){$.when(_cleanMap()).then(function(cleaned){cleaned&&_updateSource(elMapData=src)})}),events.on("countryChanged",function(value){_goToCountry(value)}),events.on("cleanMap",function(){elMap&&elMapData&&(elHideMap.off("click",_hideMapView),elLegend.off("click",".toggle-btn",_toggleLegend),elLegend.attr("class","legend hidden"),_cleanMap())});var _mapID={level2:"69e5402c",uk_level3:"c8708372",us_level3:"b5294f92"},_ccBound={ae:[[51.56934655000006,22.62094594300011],[56.383636915000096,26.074791972000142]],ar:[[-73.58803584899991,-55.05201588299981],[-53.66155187999993,-21.786937763999916]],au:[[112.911057,-54.770634],[159.111282,-9.222043]],be:[[2.544855,49.496982],[6.408097,51.505114]],bg:[[22.3805257504,41.2344859889],[28.5580814959,44.2349230007]],br:[[-73.990238,-33.751358],[-32.390875,5.270972]],ca:[[-140.99778,41.6751050889],[-52.6480987209,72.098075]],ch:[[5.958,45.819],[10.493,47.81]],cl:[[-109.45372473899987,-55.91850422299979],[-66.42080644399994,-17.506588197999974]],cn:[[73.451005,18.163247],[134.976798,53.531943]],cz:[[12.0901107788,48.55218276675],[18.8592338562,51.0555310416]],de:[[5.871619,47.269859],[15.038112,55.056526]],dk:[[8.08997684086,54.8000145534],[12.6900061378,57.730016588]],es:[[-18.167225715,27.642238674],[4.337087436,43.7934431]],fi:[[20.62316451,59.811224677],[31.56952478,70.075310364]],fr:[[-4.788050159229584,41.362165],[9.56001631027,51.1485061713]],gt:[[-92.229249,13.735338],[-88.225023,17.819326]],hk:[[113.837331576,22.177069403],[114.40129642,22.56394603]],hu:[[16.094035278,45.741343486],[22.877600546,48.56923289]],ie:[[-10.66285,51.419897],[-5.996284,55.446575]],in:[[68.1766451354,7.96553477623],[97.4025614766,35.4940095078]],it:[[6.627731,35.494864],[18.521147,47.09264]],jp:[[122.938161655,24.212103583],[153.985606316,45.520412502]],mx:[[-118.40765,14.532098],[-86.710405,32.718654]],my:[[99.64522806,.851370341],[119.278086785,7.355780341]],nl:[[3.307937,50.750367],[7.227498,53.576423]],no:[[-9.11742102799991,-54.46249765399993],[33.64039147200011,80.770086981]],nz:[[166.425827,-47.2871319],[178.550476,-34.1439329]],pe:[[-81.33755752899992,-18.33774620693788],[-68.68425248299991,-.029092711999866]],ph:[[116.928337,4.58694],[126.605347,21.070141]],pl:[[14.12127,49.00613],[24.153276,54.835693]],pt:[[-9.549835,36.959879],[-6.189159,42.154311]],ro:[[20.242825969,43.650049948],[29.699554884,48.274832256]],ru:[[19.66064,41.151416],[180,81.2504]],sa:[[34.632336,16.347891],[55.666659,32.161009]],se:[[11.10816491,55.342678127],[24.163413534,69.036355693]],sg:[[103.605694535,1.15869869159],[104.4064174364,1.4720660897]],sv:[[-90.095555,13.149017],[-87.723503,14.424133]],ua:[[22.1328277588,44.3810424805],[40.1595153809,52.368927001]],uk:[[-8.179851160822153,49.959999905],[1.768912,60.845474]],us:[[-171.791110603,18.91619],[-66.96466,71.3577635769]],za:[[16.45194,-34.83417],[32.891697,-22.12503]]};return{init:function(el){elMapWrap=el?$("#"+el):$("#alt"),elLegend=$("#map-legend"),elHideMap=elMapWrap.children(".toggle-map"),elMapWrap.append('<div id="map"></div>'),$.when(_renderMapBox()).then(function(rendered){rendered?elMapWrap.removeClass("loading"):elMapWrap.html('<div class="module-error-msg">There was an error loading the map module</div>').removeClass("loading")})},unload:function(){$.when(_cleanMap()).then(function(cleaned){cleaned&&(elHideMap.off("click",_hideMapView),elLegend.off("click",".toggle-btn",_toggleLegend),elLegend.attr("class","legend hidden"),elMap.remove(),elHideMap=null,elLegend=null,elMapWrap=null,elMap=null,elPop=null)})}}}(),HF.locs=function(){function addGroup(elWrap,groupID,data){var completed=$.Deferred(),$elWrap=$("#"+elWrap);return $mainWrap||($mainWrap=$elWrap),$.when(HF.views.addModule($elWrap,"loc_group",{groupId:groupID})).then(function(rendered){if(rendered)return _createAll(groupID,data)}).then(function(created){if(created)return _eventsBind(groupID)}).then(function(binded){binded&&completed.resolve(binded)}),completed.promise()}function _createAll(groupID,data){if(locGroupLen=groupID,selConf.country.options=_country,["country","location","radius"].forEach(function(itemSel){_createEach(itemSel)}),data){if(listLocs["country-"+groupID].setValue(data.country),data.city&&"0"!==data.city){var locName=-1!==withGeometry.indexOf(data.country)?HF.utils.locationFormat([data.city,data.region]):HF.utils.capAll(data.city);listLocs["location-"+groupID].addOption({displayName:locName,city:data.city,region:data.region,locationId:data.locationId}),listLocs["location-"+groupID].setValue(locName),listLocs["radius-"+groupID].setValue(data.radius)}}else groupID<1&&listLocs["country-0"].setValue("uk");return!0}function _createEach(selName){$("#search-"+selName+"-"+locGroupLen).selectize(selConf[selName])}function _eventsBind(groupID){return $("#loc-group-"+groupID).find("a.link").on("click",function(e){e.preventDefault(),e.stopPropagation(),_destroyGroup(groupID)}),0===groupID&&listLocs["country-"+groupID].on("change",function(){var countryValue=listLocs["country-"+groupID].getValue();events.emit("countryChanged",countryValue)}),!0}function _destroyGroup(groupID){var $elGroup=$("#loc-group-"+groupID);$elGroup.find("a.link").off("click"),$elGroup.remove(),listLocs["country-"+groupID].destroy(),listLocs["location-"+groupID].destroy(),listLocs["radius-"+groupID].destroy(),delete listLocs["country-"+groupID],delete listLocs["location-"+groupID],delete listLocs["radius-"+groupID]}function _resetField(fieldName){"country"===fieldName.split("-")[0]?listLocs[fieldName].setValue("uk"):listLocs[fieldName].setValue("")}var $mainWrap,apiLocation=pathApi+"horsefly/suggestions/city?keyword=",withGeometry=["uk","us","ca","br","mx","au"],locGroupLen=0,listLocs={},selConf={country:{valueField:"code",labelField:"name",searchField:"name",options:[],disableDelete:!0,placeholder:"Country",onChange:function(value){var groupLen=this.$input[0].id.split("search-country-");listLocs["location-"+groupLen[1]].clear(),listLocs["location-"+groupLen[1]].clearOptions(),$("#create-loc-group").toggleClass("disabled",!value.length)},onInitialize:function(){var selName="country-"+locGroupLen;listLocs[selName]=$(this)[0]}},location:{plugins:["restore_on_backspace"],persist:!1,openOnFocus:!1,closeAfterSelect:!0,maxItems:1,valueField:"displayName",labelField:"displayName",searchField:"displayName",options:[],create:!1,render:{option:function(item,escape){return"<div>"+escape(item.displayName)+"</div>"}},load:function(query,callback){var groupLen=this.$input[0].id.split("search-location-");if(!query.length)return this.close();$.ajax({type:"GET",url:apiLocation+encodeURIComponent(query)+"&country="+listLocs["country-"+groupLen[1]].getValue(),success:function(res){callback(res.slice(0,10))},error:function(){callback()}})},onDropdownClose:function(option){return this.clearOptions()},onChange:function(value){var groupLen=this.$input[0].id.split("search-location-");if(value.length){listLocs["radius-"+groupLen[1]].enable();this.options[value]}else listLocs["radius-"+groupLen[1]].setValue(""),listLocs["radius-"+groupLen[1]].disable()},onInitialize:function(){var selName="location-"+locGroupLen;listLocs[selName]=$(this)[0]}},radius:{valueField:"value",labelField:"name",searchField:"name",options:[{name:"Radius",value:""},{name:"0 mi",value:0},{name:"5 mi",value:5},{name:"10 mi",value:10},{name:"15 mi",value:15},{name:"20 mi",value:20},{name:"25 mi",value:25},{name:"30 mi",value:30},{name:"50 mi",value:50},{name:"100 mi",value:100}],onChange:function(value){HF.search.build.setData("rad",this.options[value].value)},onInitialize:function(){var selName="radius-"+locGroupLen;$(this)[0].setValue(""),listLocs[selName]=$(this)[0]}}};return{addGroup:addGroup,getGroups:function(){var isCreated=$.Deferred(),$wrapper=$("#loc-groups"),locGroupArray=[];if($wrapper.find(".loc-group-wrapper").length)return $wrapper.find(".loc-group-wrapper").each(function(){var groupID=$(this).attr("id").split("loc-group-"),fieldCountry=$(this).find("#search-country-"+groupID[1]).val(),fieldLocation=$(this).find("#search-location-"+groupID[1]).val(),fieldRadius=$(this).find("#search-radius-"+groupID[1]).val();if(fieldCountry){var groupItem={subContinent:0,country:0,region:0,city:0,locationId:0,radius:""},dataCountry=listLocs["country-"+groupID[1]].options[fieldCountry];if(groupItem.subContinent=dataCountry.continent,groupItem.country=dataCountry.code,fieldLocation){var dataLocation=listLocs["location-"+groupID[1]].options[fieldLocation];groupItem.region=dataLocation.region,groupItem.city=dataLocation.city,groupItem.locationId=dataLocation.locationId,groupItem.radius=fieldRadius}else-1===withGeometry.indexOf(fieldCountry)&&(groupItem.region="all");locGroupArray.push(groupItem)}}),isCreated.resolve(locGroupArray),isCreated.promise()},setGroups:function(elWrap,allData){var isPopulated=$.Deferred(),dataLen=allData.length-1;return allData.forEach(function(data,i){$.when(addGroup(elWrap,i,data)).then(function(done){done&&$("#loc-group-"+i).removeClass("loading")}),i===dataLen&&isPopulated.resolve(!0)}),isPopulated.promise()},resetAll:function(){var isReset=$.Deferred();if(HF.utils.isEmptyObj(listLocs))isReset.resolve(!1);else{for(var key in listLocs)if(listLocs.hasOwnProperty(key)){var keyParts=key.split("-");"0"!==keyParts[1]?_destroyGroup(keyParts[1]):_resetField(key)}isReset.resolve(!0)}return isReset.promise()}}}(),HF.dropdownList=function(){function _eventsBind($el){return elOption=$el.find("ul.child-list"),elOption.on("click","li > a",function(e){e.preventDefault(),e.stopPropagation();var action=$(this).data("action");"search-save"===action&&HF.views.modal({modalurl:"saveSearch",bgclose:!1}),"search-edit"===action&&(events.emit("cleanMap"),HF.views.set("search","build")),"search-new"===action&&(events.emit("cleanMap"),HF.search.build.setData(action)),"export-results"===action&&HF.views.modal({modalurl:"exportPDF"}),"export-csv"===action&&HF.export.exportCSV(),"run-campaign"===action&&HF.views.setDetails("wammee","run",null,"parent","ext")}),!0}function _eventsUnbind(elID){return $("#"+elID).find("ul.child-list").off("click"),!0}var _ddlConf={searchOpt:{ddlId:"search-options",ddlName:"Search Options",ddlItems:[{name:"Save this search",action:"search-save",icon:"save"},{name:"Edit search criteria",action:"search-edit",icon:"edit_mode"},{name:"Create new search",action:"search-new",icon:"search"},{name:"Run campaign",action:"run-campaign",icon:"play_arrow"},{name:"Export results to PDF",action:"export-results",icon:"picture_as_pdf"},{name:"Export results to CSV",action:"export-csv",icon:"format_line_spacing"}]}};return{init:function(elID,ddlName){var completed=$.Deferred(),$el=$("#"+elID);return $.when(HF.views.addModule($el,"dropdown_list",_ddlConf[ddlName])).then(function(added){if(added)return _eventsBind($el)}).then(function(binded){binded&&completed.resolve(binded)}),completed.promise()},unload:function(elID){var completed=$.Deferred();return $.when(_eventsUnbind(elID)).then(function(unbinded){unbinded&&completed.resolve(unbinded)}),completed.promise()}}}(),HF.export=function(){function getPercentage(value,total){var percent=100*value/total,multiplier=Math.pow(10,0);return Math.round(percent*multiplier)/multiplier}function convertToCSV(objArray){for(var array="object"!=typeof objArray?JSON.parse(objArray):objArray,str="",i=0;i<array.length;i++){var line="";for(var index in array[i])""!==line&&(line+=","),line+=array[i][index];str+=line+"\r\n"}return str}function exportCSVFile(headers,items,fileTitle){headers&&items.unshift(headers);var csv=convertToCSV(JSON.stringify(items)),exportedFilenmae=fileTitle+".csv"||"export.csv",blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(blob,exportedFilenmae);else{var link=document.createElement("a");if(void 0!==link.download){var url=URL.createObjectURL(blob);link.setAttribute("href",url),link.setAttribute("download",exportedFilenmae),link.style.visibility="hidden",document.body.appendChild(link),link.click(),document.body.removeChild(link)}}}return{exportCSV:function(){var itemsFormatted=[],tmpData=HF.results.list.getData("searchData"),tmpID=HF.results.list.getData("searchId"),tmpDate=Date.now(),tmpLevel=tmpData.geo.filter(function(val){return 0!==val&&"0"!==val}).length,currencyCode=HF.utils.getCurrencyCode(tmpData.cur),searchLevel=tmpLevel?"level"+tmpLevel:"level1",regions=HF.results.list.getCached(searchLevel).regions,csvCounter=0,headers={location:"Location".replace(/,/g,""),candidates:"Supply Count",min_salary:"Avg Low Salary ("+currencyCode+")",avg_salary:"Avg Salary ("+currencyCode+")",max_salary:"Avg High Salary ("+currencyCode+")",adverts:"Job Count",supply_demand:"Candidates per Role",gen_0:"Gender (male %)",gen_1:"Gender (female %)",exp_0:"YoE (0-3 years %)",exp_1:"YoE (4-7 years %)",exp_2:"YoE (8+ years %)"};for(var key in regions)if(regions.hasOwnProperty(key)){var snd=Math.round(regions[key].candidates/regions[key].jobposts);if(itemsFormatted.push({location:HF.utils.capAll(regions[key].location),candidates:regions[key].candidates,min_salary:regions[key].salary.min,avg_salary:regions[key].salary.avg,max_salary:regions[key].salary.max,adverts:regions[key].jobposts,supply_demand:snd&&snd!==1/0?snd:"n/a",gen_0:getPercentage(regions[key].gender[1],regions[key].gender[2]),gen_1:getPercentage(regions[key].gender[0],regions[key].gender[2]),exp_0:getPercentage(regions[key].explevel[0],regions[key].explevel[3]),exp_1:getPercentage(regions[key].explevel[1],regions[key].explevel[3]),exp_2:getPercentage(regions[key].explevel[2],regions[key].explevel[3])}),++csvCounter>=csvLimit)break}exportCSVFile(headers,itemsFormatted,"horsefly_"+tmpID+"_"+tmpDate)}}}(),HF.modal.doLogout=function(){function _eventsBind(){return continueBtn=elModal.find("#continue-session"),cancelBtn=elModal.find("#cancel-session"),continueBtn.on("click",function(e){e.preventDefault(),e.stopPropagation(),_continueSession()}),cancelBtn.on("click",function(e){e.preventDefault(),e.stopPropagation(),location.href="/dashboard"}),!0}function _continueSession(){elModal.find(".m-foot > a.m-close").trigger("click")}var elModal,continueBtn,cancelBtn;return{load:function($el){var loaded=$.Deferred();return elModal=$el,$.when(_eventsBind()).then(function(binded){loaded.resolve(binded)}),loaded.promise()},unload:function(){return continueBtn.off("click"),cancelBtn.off("click"),continueBtn=null,cancelBtn=null,modalNow="",!0}}}(),HF.modal.loggedOut=function(){return{load:function($el){return setTimeout(function(){location.href="/dashboard"},5e3),!0},unload:function(){return!0}}}(),HF.modal.deleteSearch=function(){function _eventsBind(){return(deleteBtn=elModal.find("#delete-confirm")).on("click",function(e){e.preventDefault(),e.stopPropagation(),_processRemove()}),!0}function _processRemove(){elModal.find(".m-foot").css("display","none"),elModal.addClass("loading"),$.when(_removeSearch()).then(function(done){return HF.search.saved.updateData()}).then(function(updated){elModal.find(".m-body").html("<h3>Delete complete</h3>"),elModal.removeClass("loading"),setTimeout(function(){elModal.find(".m-foot > a.m-close").trigger("click")},2e3)})}function _removeSearch(){var toDelete=HF.search.saved.getData("toDelete"),payload={searchIds:JSON.stringify(toDelete)};return $.ajax({type:"POST",url:pathApi+"horsefly/search/delete",data:payload,crossDomain:!0})}var elModal,deleteBtn;return{load:function($el){var loaded=$.Deferred();return elModal=$el,$.when(_eventsBind()).then(function(binded){loaded.resolve(binded)}),loaded.promise()},unload:function(){return HF.search.saved.updateData(!0),deleteBtn.off("click"),deleteBtn=null,modalNow="",!0}}}(),HF.modal.saveSearch=function(){function _eventsBind(){return saveBtn=elModal.find("#save-confirm"),(saveName=elModal.find("#save_search")).on("keyup",function(e){$(this).val().trim().length>2?saveBtn.removeClass("disabled"):saveBtn.addClass("disabled")}),saveBtn.on("click",function(e){if(e.preventDefault(),e.stopPropagation(),$(this).hasClass("disabled"))return!1;_processSave()}),!0}function _processSave(){elModal.find(".m-foot").css("display","none"),elModal.addClass("loading"),$.when(_saveSearch()).then(function(done){HF.search.saved.resetCached(),elModal.find(".m-body").html("<h3>Search was saved successfully</h3>"),elModal.removeClass("loading"),setTimeout(function(){elModal.find(".m-foot > a.m-close").trigger("click")},2e3)})}function _saveSearch(){var payload={searchName:saveName.val().trim(),searchId:HF.results.list.getData("searchId")};return $.ajax({type:"POST",url:pathApi+"horsefly/search/save",data:payload,crossDomain:!0})}var elModal,saveBtn,saveName;return{load:function($el){var loaded=$.Deferred();return elModal=$el,$.when(_eventsBind()).then(function(binded){loaded.resolve(binded)}),loaded.promise()},unload:function(){return saveName.off("keyup"),saveBtn.off("click"),saveName=null,saveBtn=null,modalNow="",!0}}}(),HF.modal.exportPDF=function(){function _getCanvas(){var isReady=$.Deferred();return html2canvas($("#map").get(0),{useCORS:!0,ignoreElements:function(element){return"mapboxgl-control-container"===element.className}}).then(function(canvas){isReady.resolve(canvas)}),isReady.promise()}function _b64toBlob(b64Data,contentType,sliceSize){contentType=contentType||"",sliceSize=sliceSize||512;for(var byteCharacters=atob(b64Data),byteArrays=[],offset=0;offset<byteCharacters.length;offset+=sliceSize){for(var slice=byteCharacters.slice(offset,offset+sliceSize),byteNumbers=new Array(slice.length),i=0;i<slice.length;i++)byteNumbers[i]=slice.charCodeAt(i);var byteArray=new Uint8Array(byteNumbers);byteArrays.push(byteArray)}return new Blob(byteArrays,{type:contentType})}function _eventsBind($el){return pdfBtn=$el.find("#make-pdf-preview"),mapBtn=$("#add-mapdata"),window.hasEthnicity||$("#add-chart-ethnicity").prop("checked",!1),mapBtn.on("change",function(e){$("span.warning").toggleClass("show",this.checked)}),pdfBtn.on("click",function(e){e.preventDefault(),e.stopPropagation();var checkbox=$el.find('input[name="addToPDF"]'),targetUrl="pdf_report.html"+_pdfPath;checkbox.each(function(){var isChecked=$(this).prop("checked")?"=1":"=0";targetUrl+="&"+$(this).val()+isChecked}),mapBtn.prop("checked")?$.when(_getCanvas()).then(function(canvas){document.body.appendChild(canvas);var block=canvas.toDataURL("image/png").split(";"),contentType=block[0].split(":")[1],blob=_b64toBlob(block[1].split(",")[1],contentType),fileData=new FormData;fileData.append("searchId",HF.results.list.getData("searchId")),fileData.append("map",blob),$.ajax({type:"POST",url:pathApi+"horsefly/renderMap",data:fileData,crossDomain:!0,contentType:!1,processData:!1,async:!1,cache:!1,complete:function(data){window.open(targetUrl,"")}})}):window.open(targetUrl,"")}),!0}var pdfBtn,mapBtn,_pdfPath="";return{load:function($el){var loaded=$.Deferred(),searchId=HF.results.list.getData("searchId"),searchData=HF.results.list.getData("searchData"),filters=JSON.parse(searchData.payload.filters),geoPath=searchData.geo.join("/"),radius=searchData.rad?searchData.rad:0;return _pdfPath="?sid="+searchId+"&geo="+geoPath+"&cur="+searchData.cur+"&rad="+radius+"&male="+filters.male+"&female="+filters.female+"&yoe0="+filters.yoe0+"&yoe1="+filters.yoe1+"&yoe2="+filters.yoe2,$.when(_eventsBind($el)).then(function(binded){loaded.resolve(binded)}),loaded.promise()},unload:function(){return pdfBtn.off("click"),mapBtn.off("change"),_pdfPath="",modalNow="",pdfBtn=null,mapBtn=null,!0}}}();